
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Título para la calculadora de trabajo gravitatorio -->
  <title>Calculadora de Trabajo de Energía Potencial Gravitatoria – Espacio de Simulación</title>

  <!-- Estilos y scripts principales -->
  <link rel="stylesheet" href="../css/main.css" />
  <link rel="icon" href="../public/favicon.ico" />
  <link rel="manifest" href="../public/manifest.json" />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    rel="stylesheet"
  />
  <!-- KaTeX: renderizado de fórmulas -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
  />
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
</head>

<body class="bg-background min-h-screen">
    <!-- Header -->
    <header class="bg-surface shadow-subtle border-b border-secondary-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                            <!-- Icono de peso para simbolizar la gravedad -->
                            <i class="fas fa-weight-hanging text-white text-sm"></i>
                        </div>
                        <!-- Encabezado principal -->
                        <h1 class="text-xl font-semibold text-text-primary">Calculadora de Trabajo Gravitatorio</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button class="flex items-center space-x-2 px-3 py-2 text-sm text-secondary-600 hover:text-primary transition-colors">
                        <i class="fas fa-globe text-sm"></i>
                        <span>ES</span>
                    </button>
                    <button class="p-2 text-secondary-600 hover:text-primary transition-colors" title="Ayuda">
                        <i class="fas fa-question-circle text-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Interactive Grid Section -->
        <div class="w-full mb-6">
            <div class="card">
                <div class="h-full flex flex-col">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-text-primary">Cuadrícula Interactiva</h2>
                        <div class="flex items-center space-x-4 text-sm text-secondary-600">
                            <!-- Mensaje sin zoom y selector de unidad -->
                            <span>Arrastra masas para moverlas</span>
                            <label for="distanceUnit">Unidad:</label>
                            <select id="distanceUnit" class="input-field text-sm">
                                <option value="km">km</option>
                                <option value="m">m</option>
                                <option value="cm">cm</option>
                                <option value="mm" selected>mm</option>
                                <option value="um">μm</option>
                            </select>
                        </div>
                    </div>
                    <!-- Grid Container -->
                    <div class="relative bg-secondary-50 rounded-lg border-2 border-secondary-200 overflow-hidden" style="height: 500px;">
                        <svg id="electricFieldGrid" class="w-full h-full cursor-crosshair"
                             viewBox="0 0 600 400" preserveAspectRatio="xMidYMid meet">
                            <defs>
                                <!-- Patrón de rejilla gruesa -->
                                <pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse"
                                         patternTransform="translate(0,20)">
                                    <path d="M 30 0 L 0 0 0 30" fill="none" stroke="#CBD5E1" stroke-width="1" />
                                </pattern>
                                <!-- Patrón de rejilla fina -->
                                <pattern id="gridFine" width="6" height="6" patternUnits="userSpaceOnUse"
                                         patternTransform="translate(0,2)">
                                    <path d="M 6 0 L 0 0 0 6" fill="none" stroke="#E5E7EB" stroke-width="0.5" />
                                </pattern>
                            </defs>
                            <g id="zoomGroup">
                                <!-- Rejilla fina (oculta por defecto) -->
                                <rect width="100%" height="100%" fill="url(#gridFine)" opacity="0" pointer-events="none" />
                                <!-- Rejilla principal -->
                                <rect width="100%" height="100%" fill="url(#grid)" pointer-events="none" />
                                <!-- Ejes -->
                                <line x1="300" y1="0" x2="300" y2="400" stroke="#475569" stroke-width="2" />
                                <line x1="0" y1="200" x2="600" y2="200" stroke="#475569" stroke-width="2" />
                                <!-- Etiquetas de ejes -->
                                <text x="580" y="195" fill="#475569" font-size="14" font-weight="500">X</text>
                                <text x="305" y="15" fill="#475569" font-size="14" font-weight="500">Y</text>
                                <!-- Coordenadas de la rejilla extendidas -->
                                <g id="gridCoordinates">
                                    <!-- Marcas del eje X positivo -->
                                    <text x="330" y="195" fill="#64748B" font-size="10">1</text>
                                    <text x="360" y="195" fill="#64748B" font-size="10">2</text>
                                    <text x="390" y="195" fill="#64748B" font-size="10">3</text>
                                    <text x="420" y="195" fill="#64748B" font-size="10">4</text>
                                    <text x="450" y="195" fill="#64748B" font-size="10">5</text>
                                    <text x="480" y="195" fill="#64748B" font-size="10">6</text>
                                    <text x="510" y="195" fill="#64748B" font-size="10">7</text>
                                    <text x="540" y="195" fill="#64748B" font-size="10">8</text>
                                    <text x="570" y="195" fill="#64748B" font-size="10">9</text>
                                    <!-- Marcas del eje X negativo -->
                                    <text x="270" y="195" fill="#64748B" font-size="10">-1</text>
                                    <text x="240" y="195" fill="#64748B" font-size="10">-2</text>
                                    <text x="210" y="195" fill="#64748B" font-size="10">-3</text>
                                    <text x="180" y="195" fill="#64748B" font-size="10">-4</text>
                                    <text x="150" y="195" fill="#64748B" font-size="10">-5</text>
                                    <text x="120" y="195" fill="#64748B" font-size="10">-6</text>
                                    <text x="90"  y="195" fill="#64748B" font-size="10">-7</text>
                                    <text x="60"  y="195" fill="#64748B" font-size="10">-8</text>
                                    <text x="30"  y="195" fill="#64748B" font-size="10">-9</text>
                                    <!-- Marcas del eje Y positivo -->
                                    <text x="305" y="170" fill="#64748B" font-size="10">1</text>
                                    <text x="305" y="140" fill="#64748B" font-size="10">2</text>
                                    <text x="305" y="110" fill="#64748B" font-size="10">3</text>
                                    <text x="305" y="80"  fill="#64748B" font-size="10">4</text>
                                    <text x="305" y="50"  fill="#64748B" font-size="10">5</text>
                                    <text x="305" y="20"  fill="#64748B" font-size="10">6</text>
                                    <!-- Marcas del eje Y negativo -->
                                    <text x="305" y="230" fill="#64748B" font-size="10">-1</text>
                                    <text x="305" y="260" fill="#64748B" font-size="10">-2</text>
                                    <text x="305" y="290" fill="#64748B" font-size="10">-3</text>
                                    <text x="305" y="320" fill="#64748B" font-size="10">-4</text>
                                    <text x="305" y="350" fill="#64748B" font-size="10">-5</text>
                                    <text x="305" y="380" fill="#64748B" font-size="10">-6</text>
                                </g>
                                <!-- Grupo para masas -->
                                <g id="charges"></g>
                            </g>
                        </svg>
                        <!-- Display de coordenadas del ratón -->
                        <div id="coordinateDisplay" class="absolute top-4 left-4 bg-surface px-3 py-2 rounded-lg shadow-subtle border border-secondary-200 text-sm font-mono opacity-0 transition-opacity">
                            <span id="currentCoords">X: 0, Y: 0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- M1 controls -->
            <div class="card">
                <h3 class="text-md font-semibold text-text-primary mb-3 flex items-center">
                    <div class="w-3 h-3 bg-success rounded-full mr-2"></div>
                    Masa M₁
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Valor</label>
                            <input type="number" id="q1Value" class="input-field text-sm" placeholder="5.0" value="5.0" step="0.1" min="0.1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Unidades</label>
                            <select id="q1Units" class="input-field text-sm">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coordenadas</label>
                            <input type="number" id="q1CoordX" class="coordinate-input" placeholder="x" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1 invisible">.</label>
                            <input type="number" id="q1CoordY" class="coordinate-input" placeholder="y" />
                        </div>
                    </div>
                    <button id="updateQ1Position" class="btn-secondary w-full text-xs">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Actualizar Posición
                    </button>
                    <div class="text-base tex text-secondary-600"><span id="q1Position">Posición: No colocada</span></div>
                    <div class="text-base text-secondary-600 mt-1"><span id="q1DisplayValue">Masa: No definida</span></div>
                </div>
            </div>
            <!-- M2 controls -->
            <div class="card">
                <h3 class="text-md font-semibold text-text-primary mb-3 flex items-center">
                    <div class="w-3 h-3 bg-accent rounded-full mr-2"></div>
                    Masa M₂
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Valor</label>
                            <input type="number" id="q2Value" class="input-field text-sm" placeholder="3.0" value="3.0" step="0.1" min="0.1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Unidades</label>
                            <select id="q2Units" class="input-field text-sm">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coordenadas</label>
                            <input type="number" id="q2CoordX" class="coordinate-input" placeholder="x" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1 invisible">.</label>
                            <input type="number" id="q2CoordY" class="coordinate-input" placeholder="y" />
                        </div>
                    </div>
                    <button id="updateQ2Position" class="btn-secondary w-full text-xs">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Actualizar Posición
                    </button>
                    <div class="text-base tex text-secondary-600"><span id="q2Position">Posición: No colocada</span></div>
                    <div class="text-base text-secondary-600 mt-1"><span id="q2DisplayValue">Masa: No definida</span></div>
                </div>
            </div>
            <!-- M3 controls -->
            <div class="card">
                <h3 class="text-md font-semibold text-text-primary mb-3 flex items-center">
                    <div class="w-3 h-3 bg-primary rounded-full mr-2"></div>
                    Masa M₃
                </h3>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Valor</label>
                            <input type="number" id="q3Value" class="input-field text-sm" placeholder="1.0" value="1.0" step="0.1" min="0.1" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Unidades</label>
                            <select id="q3Units" class="input-field text-sm">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                            </select>
                        </div>
                    </div>
                    <!-- Campos para posición inicial de M3 -->
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coord. inicial X</label>
                            <input type="number" id="q3CoordX" class="coordinate-input" placeholder="x" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coord. inicial Y</label>
                            <input type="number" id="q3CoordY" class="coordinate-input" placeholder="y" />
                        </div>
                    </div>
                    <button id="updateQ3InitialPosition" class="btn-secondary w-full text-xs mt-1">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Actualizar posición inicial
                    </button>
                    <!-- Campos para posición final de M3 -->
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coord. final X</label>
                            <input type="number" id="q3FinalCoordX" class="coordinate-input" placeholder="x" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-text-secondary mb-1">Coord. final Y</label>
                            <input type="number" id="q3FinalCoordY" class="coordinate-input" placeholder="y" />
                        </div>
                    </div>
                    <button id="updateQ3FinalPosition" class="btn-secondary w-full text-xs mt-1">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Actualizar posición final
                    </button>
                    <div class="text-base text-secondary-600 mt-2"><span id="q3InitialPosition">Posición inicial: No colocada</span></div>
                    <div class="text-base text-secondary-600 mt-1"><span id="q3FinalPosition">Posición final: -</span></div>
                    <div class="text-base text-secondary-600 mt-1"><span id="q3DisplayValue">Masa: No definida</span></div>
                    <div class="flex gap-2 pt-1">
                        <button id="clearAll" class="flex-1 btn-secondary text-xs">
                            <i class="fas fa-trash-alt mr-1"></i>
                            Limpiar
                        </button>
                        <button id="autoPlace" class="flex-1 btn-secondary text-xs">
                            <i class="fas fa-magic mr-1"></i>
                            Auto
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calculations Panel -->
        <div class="w-full">
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-text-primary">Cálculos Matemáticos</h2>
                    <div class="flex items-center space-x-2">
                        <button id="toggleCalculations" class="btn-secondary text-sm">
                            <i class="fas fa-chevron-up"></i><span class="hidden sm:inline ml-2">Contraer</span>
                        </button>
                    </div>
                </div>
                <div id="calculationsContent" class="overflow-y-auto">
                    <!-- Resultados iniciales -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Vectores iniciales -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-vector-square text-blue-600 mr-2"></i>
                                Vectores de posición (inicial)
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div><span id="r1InitialVector">No calculado</span></div>
                                <div><span id="r2InitialVector">No calculado</span></div>
                            </div>
                        </div>
                        <!-- Módulos iniciales -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-ruler text-purple-600 mr-2"></i>
                                Módulos de los vectores (inicial)
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div><span id="r1InitialMagnitude">No calculado</span></div>
                                <div><span id="r2InitialMagnitude">No calculado</span></div>
                            </div>
                        </div>
                        <!-- Energías iniciales -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-weight-hanging text-warning mr-2"></i>
                                Energías potenciales individuales (inicial)
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div><span id="U1InitialValue">No calculado</span></div>
                                <div><span id="U2InitialValue">No calculado</span></div>
                            </div>
                        </div>
                        <!-- Energía total inicial -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-plus text-primary mr-2"></i>
                                Energía potencial total (inicial)
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div><span id="UTotalInitialValue">No calculado</span></div>
                            </div>
                        </div>
                    </div>
                    <!-- Separador -->
                    <hr class="my-4 border-secondary-200" />
                    <!-- Resultados finales -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-vector-square text-blue-600 mr-2"></i>
                                Vectores de posición (final)
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div><span id="r1FinalVector">No calculado</span></div>
                                <div><span id="r2FinalVector">No calculado</span></div>
                            </div>
                        </div>
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-ruler text-purple-600 mr-2"></i>
                                Módulos de los vectores (final)
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div><span id="r1FinalMagnitude">No calculado</span></div>
                                <div><span id="r2FinalMagnitude">No calculado</span></div>
                            </div>
                        </div>
                        <!-- Energías finales -->
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-weight-hanging text-warning mr-2"></i>
                                Energías potenciales individuales (final)
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div><span id="U1FinalValue">No calculado</span></div>
                                <div><span id="U2FinalValue">No calculado</span></div>
                            </div>
                        </div>
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-plus text-primary mr-2"></i>
                                Energía potencial total (final)
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <div><span id="UTotalFinalValue">No calculado</span></div>
                            </div>
                        </div>
                    </div>
                    <!-- Separador y trabajo -->
                    <hr class="my-4 border-secondary-200" />
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        <div class="bg-secondary-50 rounded-lg p-4">
                            <h3 class="text-sm font-semibold text-text-primary mb-3 flex items-center">
                                <i class="fas fa-briefcase text-green-600 mr-2"></i>
                                Trabajo realizado
                            </h3>
                            <div class="space-y-2 text-sm font-mono">
                                <!-- Fórmula del trabajo con subíndices correctos -->
                                <div><span id="workFormula">W = U_{3}^{i} - U_{3}^{f}</span></div>
                                <div class="flex items-center space-x-2">
                                    <span id="workValue">No calculado</span>
                                    <button id="toggleWorkInfo" class="btn-secondary text-xs px-2 py-1">+Info</button>
                                </div>
                                <div id="workInfoText" class="mt-2 text-xs text-secondary-600 hidden"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de instrucciones -->
    <div id="instructionsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-surface rounded-xl shadow-medium max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold text-text-primary">Instrucciones de Uso</h2>
                    <button id="closeInstructions" class="text-secondary-600 hover:text-text-primary">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-4 text-sm text-text-secondary">
                    <div>
                        <h3 class="font-semibold text-text-primary mb-2">1. Colocar y Editar Masas</h3>
                        <p>Haz clic en la cuadrícula para colocar masas o usa los campos de coordenadas para posicionarlas exactamente. Arrastra las masas para moverlas interactivamente.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-text-primary mb-2">2. Navegación sin zoom</h3>
                        <p>La cuadrícula tiene un tamaño fijo; los ejes muestran marcadores completos hasta los extremos.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-text-primary mb-2">3. Selección de unidades</h3>
                        <p>Selecciona la unidad de longitud (km, m, cm, mm, μm) para las coordenadas; los cálculos se actualizan automáticamente.</p>
                    </div>
                    <div>
                        <h3 class="font-semibold text-text-primary mb-2">4. Energía y Trabajo</h3>
                        <p>Define M₁ y M₂, luego coloca M₃ en una posición inicial y otra final. La aplicación mostrará las energías potenciales inicial y final de M₃ debidas a M₁ y M₂, y el trabajo correspondiente.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Helper para KaTeX
    function renderTex(targetId, tex) {
        const el = document.getElementById(targetId);
        el.innerHTML = katex.renderToString(tex, { throwOnError: false });
    }
    class GravitationalWorkCalculator {
        constructor() {
            this.svg = document.getElementById('electricFieldGrid');
            this.zoomGroup = document.getElementById('zoomGroup');
            this.charges = { q1: null, q2: null, q3: null };
            this.G = 6.67430e-11;
            this.scale = 30;
            this.centerX = 300;
            this.centerY = 200;
            this.currentStep = 'q1';
            this.isDragging = false;
            this.dragTarget = null;
            this.dragOffset = { x: 0, y: 0 };
            this.initialPosition = null;
            this.finalPosition = null;
            this.initializeEventListeners();
            this.showInstructions();
            // Mostrar valores de masas desde el inicio
            updateQ1Display();
            updateQ2Display();
            updateQ3Display();
        }
        initializeEventListeners() {
            // Colocar masas en clic
            this.svg.addEventListener('click', (e) => this.handleGridClick(e));
            this.svg.addEventListener('mousedown', (e) => this.handleMouseDown(e));
            this.svg.addEventListener('mousemove', (e) => this.handleMouseMove(e));
            this.svg.addEventListener('mouseup', (e) => this.handleMouseUp(e));
            this.svg.addEventListener('mouseleave', (e) => this.handleMouseLeave(e));
            // Mostrar coordenadas
            this.svg.addEventListener('mousemove', (e) => this.updateCoordinateDisplay(e));
            // Cambio de unidades y valores de masa / coordenadas -> recálculo
            ['q1Value','q1Units','q1CoordX','q1CoordY'].forEach(id => document.getElementById(id).addEventListener('change', () => this.updateWorkCalculations()));
            ['q2Value','q2Units','q2CoordX','q2CoordY'].forEach(id => document.getElementById(id).addEventListener('change', () => this.updateWorkCalculations()));
            ['q3Value','q3Units'].forEach(id => document.getElementById(id).addEventListener('change', () => this.updateWorkCalculations()));
            document.getElementById('distanceUnit').addEventListener('change', () => this.updateWorkCalculations());
            // Mantener masas positivas
            ['q1Value','q2Value','q3Value'].forEach(id => {
                const el = document.getElementById(id);
                el.addEventListener('input', () => {
                    if (el.value < 0) el.value = Math.abs(el.value);
                });
            });
            // Botones de actualización
            document.getElementById('updateQ1Position').addEventListener('click', () => this.updateChargeFromCoords('q1'));
            document.getElementById('updateQ2Position').addEventListener('click', () => this.updateChargeFromCoords('q2'));
            document.getElementById('updateQ3InitialPosition').addEventListener('click', () => this.updateChargeFromCoords('q3'));
            document.getElementById('updateQ3FinalPosition').addEventListener('click', () => this.updateFinalPositionFromCoords());
            // Otros botones
            document.getElementById('clearAll').addEventListener('click', () => this.clearAll());
            document.getElementById('autoPlace').addEventListener('click', () => this.autoPlaceCharges());
            document.querySelector('[title="Ayuda"]').addEventListener('click', () => this.showInstructions());
            document.getElementById('closeInstructions').addEventListener('click', () => this.hideInstructions());
            document.getElementById('toggleCalculations').addEventListener('click', () => this.toggleCalculations());
            document.getElementById('toggleWorkInfo').addEventListener('click', () => this.toggleWorkInfo());
            // Validar valores > 0
            ['q1Value','q2Value','q3Value'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    const v = parseFloat(e.target.value);
                    if (v <= 0) {
                        e.target.setCustomValidity('El valor de la masa no puede ser cero.');
                        e.target.reportValidity();
                    } else {
                        e.target.setCustomValidity('');
                    }
                });
            });
        }
        handleGridClick(e) {
            if (this.isDragging) return;
            const coords = this.getCoordinatesFromEvent(e);
            if (this.currentStep === 'q1' && !this.charges.q1) {
                this.placeCharge('q1', coords.x, coords.y);
                this.currentStep = 'q2';
            } else if (this.currentStep === 'q2' && !this.charges.q2) {
                this.placeCharge('q2', coords.x, coords.y);
                this.currentStep = 'q3';
            } else if (this.currentStep === 'q3' && !this.charges.q3 && this.charges.q1 && this.charges.q2) {
                this.placeCharge('q3', coords.x, coords.y);
                this.updateWorkCalculations();
            }
        }
        handleMouseDown(e) {
            const target = e.target.closest('[id^="charge-"]');
            if (target) {
                this.isDragging = true;
                this.dragTarget = target.id.split('-')[1];
                const coords = this.getCoordinatesFromEvent(e);
                const charge = this.charges[this.dragTarget];
                this.dragOffset.x = coords.x - charge.x;
                this.dragOffset.y = coords.y - charge.y;
                this.svg.style.cursor = 'grabbing';
                e.preventDefault();
            }
        }
        handleMouseMove(e) {
            if (this.isDragging && this.dragTarget) {
                const coords = this.getCoordinatesFromEvent(e);
                const newX = coords.x - this.dragOffset.x;
                const newY = coords.y - this.dragOffset.y;
                this.charges[this.dragTarget] = { x: newX, y: newY };
                this.updateChargeVisual(this.dragTarget, newX, newY);
                if (this.dragTarget === 'q1' || this.dragTarget === 'q2') {
                    this.updatePositionDisplay(this.dragTarget, newX, newY);
                    this.updateCoordinateInputs(this.dragTarget, newX, newY);
                    if (this.charges.q3) this.updateWorkCalculations();
                } else {
                    // Durante el arrastre de q3, actualizar inputs pero no recalcular hasta soltar
                    this.updateCoordinateInputs('q3', newX, newY);
                }
            } else {
                const target = e.target.closest('[id^="charge-"]');
                this.svg.style.cursor = target ? 'grab' : 'crosshair';
            }
            this.updateCoordinateDisplay(e);
        }
        handleMouseUp(e) {
            if (this.isDragging) {
                // Si soltamos M3 y ya teníamos posición inicial, establecer final
                if (this.dragTarget === 'q3' && this.initialPosition) {
                    const finalCoords = this.charges.q3;
                    // Evitar coincidencia con M1 o M2
                    const coincideM1 = this.charges.q1 && Math.abs(finalCoords.x - this.charges.q1.x) < 1e-6 && Math.abs(finalCoords.y - this.charges.q1.y) < 1e-6;
                    const coincideM2 = this.charges.q2 && Math.abs(finalCoords.x - this.charges.q2.x) < 1e-6 && Math.abs(finalCoords.y - this.charges.q2.y) < 1e-6;
                    if (!coincideM1 && !coincideM2) {
                        this.finalPosition = { x: finalCoords.x, y: finalCoords.y };
                        this.updateFinalPositionDisplay(finalCoords.x, finalCoords.y);
                    }
                    this.updateWorkCalculations();
                }
                this.isDragging = false;
                this.dragTarget = null;
                this.svg.style.cursor = 'crosshair';
            }
        }
        handleMouseLeave(e) {
            this.handleMouseUp(e);
            document.getElementById('coordinateDisplay').style.opacity = '0';
        }
        getCoordinatesFromEvent(e) {
            const pt = this.svg.createSVGPoint();
            pt.x = e.clientX;
            pt.y = e.clientY;
            const local = pt.matrixTransform(this.zoomGroup.getScreenCTM().inverse());
            const x = (local.x - this.centerX) / this.scale;
            const y = -(local.y - this.centerY) / this.scale;
            return { x, y };
        }
        updateChargeFromCoords(chargeId) {
            const xInput = document.getElementById(`${chargeId}CoordX`);
            const yInput = document.getElementById(`${chargeId}CoordY`);
            const x = parseFloat(xInput.value);
            const y = parseFloat(yInput.value);
            if (!isNaN(x) && !isNaN(y)) {
                this.placeCharge(chargeId, x, y);
                this.updateWorkCalculations();
            }
        }
        updateCoordinateInputs(chargeId, x, y) {
            const xInput = document.getElementById(`${chargeId}CoordX`);
            const yInput = document.getElementById(`${chargeId}CoordY`);
            if (xInput) xInput.value = x.toFixed(1);
            if (yInput) yInput.value = y.toFixed(1);
        }
        autoPlaceCharges() {
            this.placeCharge('q1', -2, 1);
            this.placeCharge('q2', 2, -1);
            this.placeCharge('q3', 0, 0);
            this.currentStep = 'q3';
            // Vaciar inputs finales
            const xF = document.getElementById('q3FinalCoordX');
            const yF = document.getElementById('q3FinalCoordY');
            if (xF) xF.value = '';
            if (yF) yF.value = '';
            this.updateWorkCalculations();
        }
        placeCharge(chargeId, x, y) {
            this.charges[chargeId] = { x, y };
            if (chargeId === 'q3') {
                // Establecer posición inicial y reiniciar final
                this.initialPosition = { x, y };
                this.finalPosition = null;
                this.updateInitialPositionDisplay(x, y);
                const finalSpan = document.getElementById('q3FinalPosition');
                if (finalSpan) finalSpan.textContent = 'Posición final: -';
            } else {
                this.updatePositionDisplay(chargeId, x, y);
            }
            this.updateCoordinateInputs(chargeId, x, y);
            this.updateChargeVisual(chargeId, x, y);
        }
        updatePositionDisplay(chargeId, x, y) {
            const span = document.getElementById(`${chargeId}Position`);
            if (span) span.textContent = `Posición: (${x.toFixed(1)}, ${y.toFixed(1)})`;
        }
        updateChargeVisual(chargeId, x, y) {
            const svgX = this.centerX + x * this.scale;
            const svgY = this.centerY - y * this.scale;
            const chargesGroup = document.getElementById('charges');
            const existing = document.getElementById(`charge-${chargeId}`);
            if (existing) existing.remove();
            let color = '#E53935';
            if (chargeId === 'q3') color = '#2563EB';
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.id = `charge-${chargeId}`;
            group.style.cursor = 'grab';
            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', svgX);
            circle.setAttribute('cy', svgY);
            circle.setAttribute('r', 12);
            circle.setAttribute('fill', color);
            circle.setAttribute('stroke', '#ffffff');
            circle.setAttribute('stroke-width', '2');
            const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            label.setAttribute('x', svgX);
            label.setAttribute('y', svgY - 18);
            label.setAttribute('text-anchor', 'middle');
            label.setAttribute('fill', color);
            label.setAttribute('font-size', '12');
            label.setAttribute('font-weight', 'bold');
            label.textContent = chargeId === 'q1' ? 'M₁' : chargeId === 'q2' ? 'M₂' : 'M₃';
            group.appendChild(circle);
            group.appendChild(label);
            chargesGroup.appendChild(group);
        }
        updateCoordinateDisplay(e) {
            const coords = this.getCoordinatesFromEvent(e);
            document.getElementById('currentCoords').textContent = `X: ${coords.x.toFixed(1)}, Y: ${coords.y.toFixed(1)}`;
            document.getElementById('coordinateDisplay').style.opacity = '1';
        }
        updateInitialPositionDisplay(x, y) {
            const span = document.getElementById('q3InitialPosition');
            if (span) span.textContent = `Posición inicial: (${x.toFixed(1)}, ${y.toFixed(1)})`;
        }
        updateFinalPositionDisplay(x, y) {
            const span = document.getElementById('q3FinalPosition');
            if (span) span.textContent = `Posición final: (${x.toFixed(1)}, ${y.toFixed(1)})`;
        }
        updateFinalPositionFromCoords() {
            const xInput = document.getElementById('q3FinalCoordX');
            const yInput = document.getElementById('q3FinalCoordY');
            const x = parseFloat(xInput.value);
            const y = parseFloat(yInput.value);
            if (isNaN(x) || isNaN(y) || !this.initialPosition) return;
            const coincideM1 = this.charges.q1 && Math.abs(x - this.charges.q1.x) < 1e-6 && Math.abs(y - this.charges.q1.y) < 1e-6;
            const coincideM2 = this.charges.q2 && Math.abs(x - this.charges.q2.x) < 1e-6 && Math.abs(y - this.charges.q2.y) < 1e-6;
            if (coincideM1 || coincideM2) return;
            this.updateChargeVisual('q3', x, y);
            this.updateFinalPositionDisplay(x, y);
            this.finalPosition = { x, y };
            this.updateWorkCalculations();
        }
        clearAll() {
            this.charges = { q1: null, q2: null, q3: null };
            this.currentStep = 'q1';
            this.initialPosition = null;
            this.finalPosition = null;
            document.getElementById('charges').innerHTML = '';
            ['q1CoordX','q1CoordY','q2CoordX','q2CoordY','q3CoordX','q3CoordY','q3FinalCoordX','q3FinalCoordY'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('q1Position').textContent = 'Posición: No colocada';
            document.getElementById('q2Position').textContent = 'Posición: No colocada';
            document.getElementById('q3InitialPosition').textContent = 'Posición inicial: No colocada';
            document.getElementById('q3FinalPosition').textContent = 'Posición final: -';
            [
                'r1InitialVector','r2InitialVector','r1InitialMagnitude','r2InitialMagnitude','U1InitialValue','U2InitialValue','UTotalInitialValue',
                'r1FinalVector','r2FinalVector','r1FinalMagnitude','r2FinalMagnitude','U1FinalValue','U2FinalValue','UTotalFinalValue',
                'workValue'
            ].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'No calculado';
            });
            document.getElementById('workInfoText').textContent = '';
        }
        toggleCalculations() {
            const content = document.getElementById('calculationsContent');
            const button = document.getElementById('toggleCalculations');
            const icon = button.querySelector('i');
            const text = button.querySelector('span');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
                if (text) text.textContent = 'Contraer';
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
                if (text) text.textContent = 'Expandir';
            }
        }
        showInstructions() {
            document.getElementById('instructionsModal').classList.remove('hidden');
        }
        hideInstructions() {
            document.getElementById('instructionsModal').classList.add('hidden');
        }
        toggleWorkInfo() {
            const info = document.getElementById('workInfoText');
            if (info) info.classList.toggle('hidden');
        }
        // Calcular energías potenciales y trabajo con unidades dinámicas
        updateWorkCalculations() {
            const chargesReady = this.charges.q1 && this.charges.q2;
            // Mapeo de unidades a factor y latex
            const unitVal = document.getElementById('distanceUnit').value;
            let factor = 0.001;
            let unitLatex = '\\mathrm{mm}';
            switch (unitVal) {
                case 'km': factor = 1000; unitLatex = '\\mathrm{km}'; break;
                case 'm':  factor = 1;    unitLatex = '\\mathrm{m}'; break;
                case 'cm': factor = 0.01; unitLatex = '\\mathrm{cm}'; break;
                case 'mm': factor = 0.001; unitLatex = '\\mathrm{mm}'; break;
                case 'um': factor = 1e-6; unitLatex = '\\mu\\mathrm{m}'; break;
            }
            // Función para notación científica
            const sci = (val, digits = 2) => {
                if (val === 0) return val.toFixed(digits);
                const exponent = Math.floor(Math.log10(Math.abs(val)));
                const mantissa = (val / Math.pow(10, exponent)).toFixed(digits);
                if (exponent === 0) return `${mantissa}`;
                return `${mantissa}\\cdot 10^{${exponent}}`;
            };
            let UTotalInitial = null;
            let UTotalFinal = null;
            // Calcular inicial si corresponde
            if (chargesReady && this.initialPosition) {
                const m1 = this.getMassValue('q1');
                const m2 = this.getMassValue('q2');
                const m3 = this.getMassValue('q3');
                const r1 = { x: this.charges.q1.x - this.initialPosition.x, y: this.charges.q1.y - this.initialPosition.y };
                const r2 = { x: this.charges.q2.x - this.initialPosition.x, y: this.charges.q2.y - this.initialPosition.y };
                const r1Mag = Math.hypot(r1.x, r1.y);
                const r2Mag = Math.hypot(r2.x, r2.y);
                const r1Mag_m = r1Mag * factor;
                const r2Mag_m = r2Mag * factor;
                const U1 = -this.G * m1 * m3 / r1Mag_m;
                const U2 = -this.G * m2 * m3 / r2Mag_m;
                UTotalInitial = U1 + U2;
                renderTex('r1InitialVector', `\\vec{r}_1=( ${r1.x.toFixed(2)},\\; ${r1.y.toFixed(2)} )\\,${unitLatex}`);
                renderTex('r2InitialVector', `\\vec{r}_2=( ${r2.x.toFixed(2)},\\; ${r2.y.toFixed(2)} )\\,${unitLatex}`);
                renderTex('r1InitialMagnitude', `|\\vec{r}_1|=${r1Mag.toFixed(2)}\\,${unitLatex}`);
                renderTex('r2InitialMagnitude', `|\\vec{r}_2|=${r2Mag.toFixed(2)}\\,${unitLatex}`);
                renderTex('U1InitialValue', `U_{1}^{i}=${sci(U1)}\\,\\mathrm{J}`);
                renderTex('U2InitialValue', `U_{2}^{i}=${sci(U2)}\\,\\mathrm{J}`);
                renderTex('UTotalInitialValue', `U_{3}^{i}=${sci(UTotalInitial)}\\,\\mathrm{J}`);
            } else {
                document.getElementById('r1InitialVector').textContent = 'No calculado';
                document.getElementById('r2InitialVector').textContent = 'No calculado';
                document.getElementById('r1InitialMagnitude').textContent = 'No calculado';
                document.getElementById('r2InitialMagnitude').textContent = 'No calculado';
                document.getElementById('U1InitialValue').textContent = 'No calculado';
                document.getElementById('U2InitialValue').textContent = 'No calculado';
                document.getElementById('UTotalInitialValue').textContent = 'No calculado';
            }
            // Calcular final si corresponde
            if (chargesReady && this.finalPosition) {
                const m1 = this.getMassValue('q1');
                const m2 = this.getMassValue('q2');
                const m3 = this.getMassValue('q3');
                const r1f = { x: this.charges.q1.x - this.finalPosition.x, y: this.charges.q1.y - this.finalPosition.y };
                const r2f = { x: this.charges.q2.x - this.finalPosition.x, y: this.charges.q2.y - this.finalPosition.y };
                const r1Magf = Math.hypot(r1f.x, r1f.y);
                const r2Magf = Math.hypot(r2f.x, r2f.y);
                const r1Magf_m = r1Magf * factor;
                const r2Magf_m = r2Magf * factor;
                const U1f = -this.G * m1 * m3 / r1Magf_m;
                const U2f = -this.G * m2 * m3 / r2Magf_m;
                UTotalFinal = U1f + U2f;
                renderTex('r1FinalVector', `\\vec{r}_1=( ${r1f.x.toFixed(2)},\\; ${r1f.y.toFixed(2)} )\\,${unitLatex}`);
                renderTex('r2FinalVector', `\\vec{r}_2=( ${r2f.x.toFixed(2)},\\; ${r2f.y.toFixed(2)} )\\,${unitLatex}`);
                renderTex('r1FinalMagnitude', `|\\vec{r}_1|=${r1Magf.toFixed(2)}\\,${unitLatex}`);
                renderTex('r2FinalMagnitude', `|\\vec{r}_2|=${r2Magf.toFixed(2)}\\,${unitLatex}`);
                renderTex('U1FinalValue', `U_{1}^{f}=${sci(U1f)}\\,\\mathrm{J}`);
                renderTex('U2FinalValue', `U_{2}^{f}=${sci(U2f)}\\,\\mathrm{J}`);
                renderTex('UTotalFinalValue', `U_{3}^{f}=${sci(UTotalFinal)}\\,\\mathrm{J}`);
            } else {
                document.getElementById('r1FinalVector').textContent = 'No calculado';
                document.getElementById('r2FinalVector').textContent = 'No calculado';
                document.getElementById('r1FinalMagnitude').textContent = 'No calculado';
                document.getElementById('r2FinalMagnitude').textContent = 'No calculado';
                document.getElementById('U1FinalValue').textContent = 'No calculado';
                document.getElementById('U2FinalValue').textContent = 'No calculado';
                document.getElementById('UTotalFinalValue').textContent = 'No calculado';
            }
            // Calcular trabajo
            if (UTotalInitial !== null && UTotalFinal !== null) {
                const work = UTotalInitial - UTotalFinal;
                renderTex('workValue', `${sci(work)}\\,\\mathrm{J}`);
                const infoEl = document.getElementById('workInfoText');
                if (infoEl) {
                    let message = '';
                    const absW = Math.abs(work);
                    if (absW < 1e-40) {
                        message = 'No se realiza trabajo en el desplazamiento porque la energía potencial no cambia; las posiciones inicial y final se encuentran en la misma superficie equipotencial.';
                    } else if (work > 0) {
                        message = 'El trabajo es positivo, lo que indica que el sistema libera energía al mover M₃ desde la posición inicial hasta la final (la energía potencial disminuye).';
                    } else {
                        message = 'El trabajo es negativo, lo que indica que se debe suministrar energía externa para mover M₃ hasta la posición final (la energía potencial aumenta).';
                    }
                    infoEl.textContent = message;
                }
            } else {
                document.getElementById('workValue').textContent = 'No calculado';
                const infoEl = document.getElementById('workInfoText');
                if (infoEl) infoEl.textContent = '';
            }
        }
        getMassValue(chargeId) {
            const raw = parseFloat(document.getElementById(`${chargeId}Value`).value);
            const valueAbs = isNaN(raw) ? 0 : Math.abs(raw);
            const unit = document.getElementById(`${chargeId}Units`).value;
            let mult;
            if (unit === 'μg') mult = 1e-9;
            else if (unit === 'mg') mult = 1e-6;
            else if (unit === 'g') mult = 1e-3;
            else mult = 1;
            return valueAbs * mult;
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        new GravitationalWorkCalculator();
        // Renderizar la fórmula del trabajo con KaTeX una vez cargada la página
        renderTex('workFormula', 'W = U_{3}^{i} - U_{3}^{f}');
    });
    // Funciones de actualización de texto de masa
    function updateQ1Display() {
        const val = parseFloat(document.getElementById('q1Value').value);
        const unit = document.getElementById('q1Units').value;
        const v = isNaN(val) ? 0 : val;
        document.getElementById('q1DisplayValue').textContent = `Masa: ${v.toFixed(2)} ${unit}`;
    }
    function updateQ2Display() {
        const val = parseFloat(document.getElementById('q2Value').value);
        const unit = document.getElementById('q2Units').value;
        const v = isNaN(val) ? 0 : val;
        document.getElementById('q2DisplayValue').textContent = `Masa: ${v.toFixed(2)} ${unit}`;
    }
    function updateQ3Display() {
        const val = parseFloat(document.getElementById('q3Value').value);
        const unit = document.getElementById('q3Units').value;
        const v = isNaN(val) ? 0 : val;
        document.getElementById('q3DisplayValue').textContent = `Masa: ${v.toFixed(2)} ${unit}`;
    }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misión Gravitatoria: Análisis Proporcional</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MathJax Configuration -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      startup: {
        typeset: false
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .option-btn { transition: all 0.2s; }
        .option-btn:hover:not(:disabled) { transform: translateY(-2px); }
        
        .text-init { color: #2563eb; } /* Blue 600 - Inicial */
        .text-mod { color: #dc2626; }  /* Red 600 - Modificado */
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4 text-slate-800">

    <!-- Header -->
    <header class="w-full max-w-3xl flex justify-between items-center mb-6 bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
        <div>
            <h1 class="text-2xl font-black text-indigo-900 tracking-tight">Misión Gravitatoria</h1>
            <div id="level-badge" class="inline-block px-2 py-0.5 bg-indigo-600 text-white text-[10px] font-bold rounded mt-1 uppercase">Nivel 1: Cadete</div>
        </div>
        <div class="bg-slate-50 px-4 py-2 rounded-xl border border-slate-100 text-center">
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Puntuación</div>
            <div id="score-display" class="text-2xl font-mono font-bold text-slate-400 transition-colors">0.0</div>
        </div>
    </header>

    <main class="w-full max-w-3xl space-y-4">
        
        <!-- Question Card -->
        <div id="question-card" class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-100 fade-in">
            <div class="h-1.5 w-full bg-slate-100">
                <div id="progress-bar" class="h-full bg-indigo-500 transition-all duration-700" style="width: 0%"></div>
            </div>
            
            <div class="p-6 md:p-10">
                <div class="flex items-center gap-2 mb-6">
                    <span id="topic-tag" class="bg-indigo-50 text-indigo-700 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-tighter">Fuerza Gravitatoria</span>
                    <span class="text-slate-300 text-xs">|</span>
                    <span id="diff-tag" class="text-slate-400 text-xs italic">Análisis proporcional</span>
                </div>

                <div id="question-container" class="space-y-4">
                    <p id="question-text" class="text-lg md:text-xl text-slate-700 leading-relaxed font-medium">
                        Calculando órbitas...
                    </p>
                </div>

                <!-- Options -->
                <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-10">
                    <!-- Inyectado por JS -->
                </div>
            </div>
        </div>

        <!-- Explanation Card -->
        <div id="explanation-card" class="hidden bg-white rounded-3xl shadow-lg border-t-4 border-indigo-500 p-6 md:p-8 fade-in">
            <div class="flex items-center gap-2 mb-6 text-indigo-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                <h3 class="text-lg font-bold">Análisis Comparativo</h3>
            </div>
            
            <div id="explanation-content" class="space-y-6 text-slate-700 leading-relaxed">
                <!-- LaTeX dinámico -->
            </div>

            <div class="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                <button id="next-btn" onclick="game.nextQuestion()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-2xl shadow-lg shadow-indigo-200 transition transform hover:-translate-y-0.5">
                    Siguiente Objetivo &rarr;
                </button>
            </div>
        </div>
    </main>

    <footer class="mt-12 text-slate-400 text-[10px] font-bold uppercase tracking-widest pb-10">
        Simulador de Proporcionalidad Física &copy; 2024
    </footer>

    <script>
        const COL_INIT = "blue";
        const COL_MOD = "red";

        // Función mejorada para convertir decimales a fracciones LaTeX legibles
        const getLatexFrac = (val) => {
            if (Math.abs(val - 1) < 0.0001) return "1";
            
            // Buscamos una fracción exacta con denominador hasta 256 para cubrir casos como 1/36, 1/64, 1/144...
            for (let den = 1; den <= 256; den++) {
                let num = Math.round(val * den);
                if (Math.abs(val - num / den) < 0.0001) {
                    if (den === 1) return num.toString();
                    return "\\frac{" + num + "}{" + den + "}";
                }
            }
            // Fallback por si acaso, aunque con los factores usados siempre debería encontrar fracción
            return val.toFixed(2);
        };

        const TEMPLATES = {
            F: {
                label: 'Fuerza Gravitatoria',
                symbol: 'F',
                formula: 'G \\frac{[[M]] \\cdot [[m]]}{[[d]]^2}',
                vars: { M: 'masa 1', m: 'masa 2', d: 'distancia' },
                powers: { M: 1, m: 1, d: -2 }
            },
            g: {
                label: 'Intensidad de Campo',
                symbol: 'g',
                formula: 'G \\frac{[[M]]}{[[R]]^2}',
                vars: { M: 'masa', R: 'radio' },
                powers: { M: 1, R: -2 }
            },
            Ep: {
                label: 'Energía Potencial',
                symbol: 'E_p',
                formula: '-G \\frac{[[M]] \\cdot [[m]]}{[[r]]}',
                vars: { M: 'masa 1', m: 'masa 2', r: 'distancia' },
                powers: { M: 1, m: 1, r: -1 }
            },
            V: {
                label: 'Potencial Gravitatorio',
                symbol: 'V',
                formula: '-G \\frac{[[M]]}{[[r]]}',
                vars: { M: 'masa', r: 'distancia' },
                powers: { M: 1, r: -1 }
            }
        };

        const FACTORS = [
            { text: 'se duplica', val: 2 },
            { text: 'se triplica', val: 3 },
            { text: 'se cuadruplica', val: 4 },
            { text: 'se reduce a la mitad', val: 0.5 },
            { text: 'se reduce a la tercera parte', val: 0.3333333333333333 },
            { text: 'se reduce a la cuarta parte', val: 0.25 }
        ];

        class Game {
            constructor() {
                this.score = 0;
                this.currentQuestion = null;
                this.isAnswering = true;
                this.init();
            }

            init() {
                this.nextQuestion();
            }

            fmtVar(sym, idx) {
                const col = idx === 1 ? COL_INIT : COL_MOD;
                let baseLatex = "";
                if (sym.includes('_')) {
                    const parts = sym.split('_');
                    baseLatex = parts[0] + "_{" + parts[1] + "," + idx + "}";
                } else {
                    baseLatex = sym + "_{" + idx + "}";
                }
                return "{\\color{" + col + "} " + baseLatex + "}";
            }

            nextQuestion() {
                this.isAnswering = true;
                document.getElementById('explanation-card').classList.add('hidden');
                
                const magKeys = Object.keys(TEMPLATES);
                const magKey = magKeys[Math.floor(Math.random() * magKeys.length)];
                const template = TEMPLATES[magKey];
                
                const varKeys = Object.keys(template.vars);
                const changes = {};
                let countChanges = 0;

                varKeys.forEach(v => {
                    // Probabilidad de cambio aumentada para que haya casos interesantes (como 1/36)
                    if (Math.random() > 0.4 || countChanges === 0) {
                        changes[v] = FACTORS[Math.floor(Math.random() * FACTORS.length)];
                        countChanges++;
                    } else {
                        changes[v] = { text: 'se mantiene constante', val: 1 };
                    }
                });

                let resultFactor = 1;
                varKeys.forEach(v => {
                    resultFactor *= Math.pow(changes[v].val, template.powers[v]);
                });

                this.currentQuestion = { magKey, template, changes, resultFactor };
                this.render();
            }

            render() {
                const q = this.currentQuestion;
                document.getElementById('topic-tag').innerText = q.template.label;
                document.getElementById('diff-tag').innerText = "Variación de " + Object.values(q.changes).filter(c => c.val !== 1).length + " magnitud(es)";
                
                const initStyle = `<span class="text-blue-600 font-bold italic">estado inicial</span>`;
                const modStyle = `<span class="text-red-600 font-bold italic">sistema modificado</span>`;
                
                let text = "Consideremos un " + initStyle + " donde la magnitud gravitatoria vale $" + q.template.symbol + "$. Si alteramos las condiciones físicas para obtener un " + modStyle + " donde: ";
                
                const changeStrings = [];
                for (let v in q.changes) {
                    if (q.changes[v].val !== 1) {
                        changeStrings.push("la <b>" + q.template.vars[v] + "</b> " + q.changes[v].text);
                    }
                }
                text += changeStrings.join(' y ') + ".";
                text += "<br><br>¿Cuál será el valor de la nueva magnitud en comparación con la del " + initStyle + "?";

                document.getElementById('question-text').innerHTML = text;
                
                this.renderOptions();
                this.typeset();
            }

            renderOptions() {
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                
                const correctVal = this.currentQuestion.resultFactor;
                // Pool de opciones plausibles basadas en potencias
                const pool = new Set([correctVal, 1/correctVal, 1/36, 1/16, 1/9, 4, 9, 16, 1/4]);
                const options = Array.from(pool).filter(v => v > 0 && !isNaN(v)).sort(() => Math.random() - 0.5).slice(0, 4);
                if (!options.includes(correctVal)) options[0] = correctVal;

                options.sort(() => Math.random() - 0.5).forEach(val => {
                    const btn = document.createElement('button');
                    btn.className = "option-btn group p-5 bg-white border-2 border-slate-100 rounded-2xl text-left hover:border-indigo-200 hover:bg-indigo-50/30 transition shadow-sm";
                    const latex = getLatexFrac(val);
                    const sym = this.currentQuestion.template.symbol;
                    const eqPart = (latex === '1') ? '' : latex + ' \\cdot';
                    
                    btn.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-serif">$ ${this.fmtVar(sym, 2)} = ${eqPart} ${this.fmtVar(sym, 1)} $</span>
                            <div class="w-6 h-6 rounded-full border-2 border-slate-100 group-hover:border-indigo-200 flex items-center justify-center text-[10px] font-bold text-slate-300">?</div>
                        </div>
                    `;
                    btn.onclick = () => this.checkAnswer(val, btn);
                    container.appendChild(btn);
                });
            }

            checkAnswer(val, btn) {
                if (!this.isAnswering) return;
                this.isAnswering = false;

                const correct = this.currentQuestion.resultFactor;
                const isCorrect = Math.abs(val - correct) < 0.0001;

                if (isCorrect) {
                    this.score += 1.0;
                    btn.classList.replace('border-slate-100', 'border-emerald-500');
                    btn.classList.add('bg-emerald-50');
                } else {
                    this.score = Math.max(0, this.score - 0.5);
                    btn.classList.replace('border-slate-100', 'border-red-500');
                    btn.classList.add('bg-red-50');
                }

                this.updateUI();
                this.showExplanation();
            }

            updateUI() {
                const scoreDisp = document.getElementById('score-display');
                scoreDisp.innerText = this.score.toFixed(1);
                scoreDisp.className = "text-2xl font-mono font-bold " + (this.score >= 5 ? 'text-emerald-500' : 'text-indigo-600');
                
                const progress = (this.score / 10) * 100;
                document.getElementById('progress-bar').style.width = Math.min(progress, 100) + "%";
            }

            showExplanation() {
                const q = this.currentQuestion;
                const container = document.getElementById('explanation-content');
                
                let html = "<div><p class=\"font-bold mb-2\">1. Definición física:</p><p class=\"text-sm\">Partimos de la fórmula general de $" + q.template.symbol + "$: " +
                    "$$" + q.template.symbol + " = " + q.template.formula.split('[[').join('').split(']]').join('') + "$$</p></div>";

                html += "<div><p class=\"font-bold mb-2\">2. Comparación mediante cociente:</p>" +
                    "<p class=\"text-sm\">Calculamos la relación entre el " +
                    "<span class=\"text-red-600 font-bold\">estado modificado (2)</span> y el " +
                    "<span class=\"text-blue-600 font-bold\">estado inicial (1)</span>:</p></div>";

                const sym = q.template.symbol;
                const v1 = (s) => this.fmtVar(s, 1);
                const v2 = (s) => this.fmtVar(s, 2);

                const getExpr = (idx) => {
                    let f = q.template.formula;
                    for (let v in q.template.vars) {
                        f = f.split("[[" + v + "]]").join(this.fmtVar(v, idx));
                    }
                    return f;
                };

                html += `<div class="bg-slate-50 p-4 rounded-xl my-4 overflow-x-auto">
                    $$\\frac{${v2(sym)}}{${v1(sym)}} = \\frac{${getExpr(2)}}{${getExpr(1)}}$$
                </div>`;

                html += "<p class=\"text-sm\">Sustituimos las equivalencias de cada magnitud: ";
                let substList = [];
                for (let v in q.changes) {
                    if (q.changes[v].val !== 1) {
                        substList.push("$" + v2(v) + " = " + getLatexFrac(q.changes[v].val) + " " + v1(v) + "$");
                    } else {
                        substList.push("$" + v2(v) + " = " + v1(v) + "$");
                    }
                }
                html += substList.join(', ') + ".</p>";

                let numFactor = "";
                let denFactor = "";
                for (let v in q.changes) {
                    const power = q.template.powers[v];
                    const factor = q.changes[v].val;
                    if (factor === 1) continue;

                    let part = getLatexFrac(factor);
                    // Si el factor es una fracción compleja, lo ponemos entre paréntesis para la potencia
                    if (part.includes("frac")) part = "\\left(" + part + "\\right)";
                    
                    if (Math.abs(power) > 1) part = part + "^{" + Math.abs(power) + "}";
                    
                    if (power > 0) numFactor += (numFactor ? ' \\cdot ' : '') + part;
                    else denFactor += (denFactor ? ' \\cdot ' : '') + part;
                }

                if (!numFactor) numFactor = "1";
                if (!denFactor) denFactor = "1";

                html += `<div class="bg-indigo-50/50 p-4 rounded-xl my-4 overflow-x-auto text-indigo-900 font-bold">
                    $$\\frac{${v2(sym)}}{${v1(sym)}} = \\frac{${numFactor}}{${denFactor}} = ${getLatexFrac(q.resultFactor)}$$
                </div>`;

                html += "<div><p class=\"font-bold mb-2\">3. Conclusión final:</p>" +
                    "<p class=\"text-sm\">Al simplificar constantes y variables, obtenemos la fracción exacta del cambio:" +
                    "$$" + v2(sym) + " = " + getLatexFrac(q.resultFactor) + " \\cdot " + v1(sym) + "$$</p></div>";

                container.innerHTML = html;
                document.getElementById('explanation-card').classList.remove('hidden');
                this.typeset();
                
                setTimeout(() => {
                    document.getElementById('explanation-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }

            typeset() {
                if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise().catch(err => console.log('MathJax Error:', err));
                }
            }
        }

        let game;
        window.onload = () => {
            game = new Game();
        };
    </script>
</body>
</html>

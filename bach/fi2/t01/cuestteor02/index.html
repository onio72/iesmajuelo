<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Misión Satélites: Análisis Proporcional</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MathJax Configuration -->
    <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      startup: {
        typeset: false
      }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .option-btn { transition: all 0.2s; }
        .option-btn:hover:not(:disabled) { transform: translateY(-2px); }
        
        .text-init { color: #2563eb; } /* Blue 600 - Inicial */
        .text-mod { color: #dc2626; }  /* Red 600 - Modificado */
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col items-center p-4 text-slate-800">

    <!-- Header -->
    <header class="w-full max-w-3xl flex justify-between items-center mb-6 bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
        <div>
            <h1 class="text-2xl font-black text-blue-900 tracking-tight">Física de Satélites</h1>
            <div id="level-badge" class="inline-block px-2 py-0.5 bg-blue-600 text-white text-[10px] font-bold rounded mt-1 uppercase">Nivel 1: Cadete</div>
        </div>
        <div class="bg-slate-50 px-4 py-2 rounded-xl border border-slate-100 text-center">
            <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Puntuación</div>
            <div id="score-display" class="text-2xl font-mono font-bold text-slate-400 transition-colors">0.0</div>
        </div>
    </header>

    <main class="w-full max-w-3xl space-y-4">
        
        <!-- Question Card -->
        <div id="question-card" class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-100 fade-in">
            <div class="h-1.5 w-full bg-slate-100">
                <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-700" style="width: 0%"></div>
            </div>
            
            <div class="p-6 md:p-10">
                <div class="flex items-center gap-2 mb-6">
                    <span id="topic-tag" class="bg-blue-50 text-blue-700 text-[10px] font-black px-2 py-1 rounded-md uppercase tracking-tighter">Mecánica Celeste</span>
                    <span class="text-slate-300 text-xs">|</span>
                    <span id="diff-tag" class="text-slate-400 text-xs italic">Análisis proporcional</span>
                </div>

                <div id="question-container" class="space-y-4">
                    <p id="question-text" class="text-lg md:text-xl text-slate-700 leading-relaxed font-medium">
                        Sincronizando telemetría...
                    </p>
                </div>

                <!-- Options -->
                <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-10">
                    <!-- Inyectado por JS -->
                </div>
            </div>
        </div>

        <!-- Explanation Card -->
        <div id="explanation-card" class="hidden bg-white rounded-3xl shadow-lg border-t-4 border-amber-500 p-6 md:p-8 fade-in">
            <div class="flex items-center gap-2 mb-6 text-amber-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <h3 class="text-lg font-bold">Deducción de la Relación Orbital</h3>
            </div>
            
            <div id="explanation-content" class="space-y-6 text-slate-700 leading-relaxed">
                <!-- LaTeX dinámico -->
            </div>

            <div class="mt-8 pt-6 border-t border-slate-100 flex justify-end">
                <button id="next-btn" onclick="game.nextQuestion()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-2xl shadow-lg shadow-blue-200 transition transform hover:-translate-y-0.5">
                    Siguiente Parámetro &rarr;
                </button>
            </div>
        </div>
    </main>

    <footer class="mt-12 text-slate-400 text-[10px] font-bold uppercase tracking-widest pb-10">
        Simulador de Satélites &copy; 2024
    </footer>

    <script>
        const COL_INIT = "blue";
        const COL_MOD = "red";

        const getLatexFrac = (val) => {
            const eps = 0.0001;
            if (Math.abs(val - 1) < eps) return "1";
            if (Math.abs(val - Math.round(val)) < eps) return Math.round(val).toString();

            for (let den = 2; den <= 12; den++) {
                let num = Math.round(val * den);
                if (Math.abs(val - num / den) < eps) {
                    return "\\frac{" + num + "}{" + den + "}";
                }
            }

            let valSq = val * val;
            for (let den = 1; den <= 144; den++) {
                let num = Math.round(valSq * den);
                if (Math.abs(valSq - num / den) < 0.001) {
                    if (den === 1) return "\\sqrt{" + num + "}";
                    return "\\sqrt{\\frac{" + num + "}{" + den + "}}";
                }
            }

            // Ampliado a 1024 para evitar "0.00" en factores compuestos muy pequeños
            for (let den = 13; den <= 1024; den++) {
                let num = Math.round(val * den);
                if (Math.abs(val - num / den) < eps) {
                    return "\\frac{" + num + "}{" + den + "}";
                }
            }

            return val.toFixed(3); // Mayor precisión si no encuentra fracción
        };

        const TEMPLATES = {
            vesc: {
                label: 'Velocidad de Escape',
                symbol: 'v_{esc}',
                formula: '\\sqrt{\\frac{2G [[M]]}{[[R]]}}',
                vars: { M: 'masa del planeta', R: 'radio del planeta' },
                powers: { M: 0.5, R: -0.5 }
            },
            vorb: {
                label: 'Velocidad Orbital',
                symbol: 'v_{orb}',
                formula: '\\sqrt{\\frac{G [[M]]}{[[r]]}}',
                vars: { M: 'masa del planeta', r: 'radio de órbita' },
                powers: { M: 0.5, r: -0.5 }
            },
            T: {
                label: 'Periodo Orbital',
                symbol: 'T',
                formula: '2\\pi \\sqrt{\\frac{[[r]]^3}{G [[M]]}}',
                vars: { r: 'radio de órbita', M: 'masa central' },
                powers: { r: 1.5, M: -0.5 }
            },
            Ec: {
                label: 'Energía Cinética',
                symbol: 'E_c',
                formula: '\\frac{G [[M]] [[m]]}{2 [[r]]}',
                vars: { M: 'masa del planeta', m: 'masa del satélite', r: 'radio de órbita' },
                powers: { M: 1, m: 1, r: -1 }
            },
            Ep: {
                label: 'Energía Potencial',
                symbol: 'E_p',
                formula: '-\\frac{G [[M]] [[m]]}{[[r]]}',
                vars: { M: 'masa del planeta', m: 'masa del satélite', r: 'radio de órbita' },
                powers: { M: 1, m: 1, r: -1 }
            },
            Em: {
                label: 'Energía Mecánica',
                symbol: 'E_m',
                formula: '-\\frac{G [[M]] [[m]]}{2 [[r]]}',
                vars: { M: 'masa del planeta', m: 'masa del satélite', r: 'radio de órbita' },
                powers: { M: 1, m: 1, r: -1 }
            }
        };

        const FACTORS = [
            { text: 'se duplica', val: 2 },
            { text: 'se triplica', val: 3 },
            { text: 'se cuadruplica', val: 4 },
            { text: 'se multiplica por 6', val: 6 },
            { text: 'se multiplica por 9', val: 9 },
            { text: 'se multiplica por 12', val: 12 },
            { text: 'se reduce a la mitad', val: 0.5 },
            { text: 'se reduce a la tercera parte', val: 1/3 },
            { text: 'se reduce a la cuarta parte', val: 0.25 }
        ];

        class Game {
            constructor() {
                this.score = 0;
                this.currentQuestion = null;
                this.isAnswering = true;
                this.init();
            }

            init() {
                this.nextQuestion();
            }

            fmtVar(sym, idx) {
                const col = idx === 1 ? COL_INIT : COL_MOD;
                let baseLatex = "";
                if (sym.includes('_')) {
                    const parts = sym.split('_');
                    baseLatex = parts[0] + "_{" + parts[1] + "," + idx + "}";
                } else {
                    baseLatex = sym + "_{" + idx + "}";
                }
                return "{\\color{" + col + "} " + baseLatex + "}";
            }

            nextQuestion() {
                this.isAnswering = true;
                document.getElementById('explanation-card').classList.add('hidden');
                
                const magKeys = Object.keys(TEMPLATES);
                const magKey = magKeys[Math.floor(Math.random() * magKeys.length)];
                const template = TEMPLATES[magKey];
                
                const varKeys = Object.keys(template.vars);
                let changes = {};
                let resultFactor = 0;

                // Loop para asegurar que el factor no sea cero ni extremadamente pequeño (límite de seguridad)
                while (resultFactor < 0.001) {
                    let countChanges = 0;
                    changes = {};
                    resultFactor = 1;

                    varKeys.forEach(v => {
                        if (Math.random() > 0.4 || countChanges === 0) {
                            const f = FACTORS[Math.floor(Math.random() * FACTORS.length)];
                            changes[v] = f;
                            countChanges++;
                        } else {
                            changes[v] = { text: 'se mantiene constante', val: 1 };
                        }
                    });

                    varKeys.forEach(v => {
                        resultFactor *= Math.pow(changes[v].val, template.powers[v]);
                    });
                }

                this.currentQuestion = { magKey, template, changes, resultFactor };
                this.render();
            }

            render() {
                const q = this.currentQuestion;
                document.getElementById('topic-tag').innerText = q.template.label;
                document.getElementById('diff-tag').innerText = "Análisis de " + Object.values(q.changes).filter(c => c.val !== 1).length + " variable(s)";
                
                const initStyle = `<span class="text-blue-600 font-bold italic">configuración inicial</span>`;
                const modStyle = `<span class="text-red-600 font-bold italic">nueva configuración</span>`;
                
                let text = "Un satélite se encuentra en una " + initStyle + " con magnitud $" + q.template.symbol + "$. Consideremos ahora una " + modStyle + " en la que: ";
                
                const changeStrings = [];
                for (let v in q.changes) {
                    if (q.changes[v].val !== 1) {
                        changeStrings.push("la <b>" + q.template.vars[v] + "</b> " + q.changes[v].text);
                    }
                }
                text += changeStrings.join(' y ') + ".";
                text += "<br><br>¿Cuál será el valor de la magnitud resultante bajo estas nuevas condiciones?";

                document.getElementById('question-text').innerHTML = text;
                
                this.renderOptions();
                this.typeset();
            }

            renderOptions() {
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                
                const correctVal = this.currentQuestion.resultFactor;
                // Pool de opciones plausibles, filtrando estrictamente valores positivos > 0.001
                const pool = new Set([correctVal, 1/correctVal, Math.sqrt(correctVal), correctVal*correctVal, 1, 2, 4, 8, 1/8, 0.5, 0.25]);
                const options = Array.from(pool).filter(v => v >= 0.001 && !isNaN(v)).sort(() => Math.random() - 0.5).slice(0, 4);
                if (!options.includes(correctVal)) options[0] = correctVal;

                options.sort(() => Math.random() - 0.5).forEach(val => {
                    const btn = document.createElement('button');
                    btn.className = "option-btn group p-5 bg-white border-2 border-slate-100 rounded-2xl text-left hover:border-blue-200 hover:bg-blue-50/30 transition shadow-sm";
                    btn.dataset.val = val; 
                    
                    const latex = getLatexFrac(val);
                    const sym = this.currentQuestion.template.symbol;
                    const eqPart = (latex === '1') ? '' : latex + ' \\cdot';
                    
                    btn.innerHTML = `
                        <div class="flex items-center justify-between">
                            <span class="text-lg font-serif">$ ${this.fmtVar(sym, 2)} = ${eqPart} ${this.fmtVar(sym, 1)} $</span>
                            <div class="status-icon w-6 h-6 rounded-full border-2 border-slate-100 group-hover:border-blue-200 flex items-center justify-center text-[10px] font-bold text-slate-300">?</div>
                        </div>
                    `;
                    btn.onclick = () => this.checkAnswer(val, btn);
                    container.appendChild(btn);
                });
            }

            checkAnswer(val, btn) {
                if (!this.isAnswering) return;
                this.isAnswering = false;

                const correct = this.currentQuestion.resultFactor;
                const isCorrect = Math.abs(val - correct) < 0.001;

                const buttons = document.querySelectorAll('.option-btn');
                buttons.forEach(b => {
                    b.disabled = true;
                    b.classList.add('opacity-50', 'cursor-not-allowed');
                });

                btn.classList.remove('opacity-50'); 

                if (isCorrect) {
                    this.score += 1.0;
                    btn.classList.replace('border-slate-100', 'border-emerald-500');
                    btn.classList.add('bg-emerald-50', 'text-emerald-900');
                    const icon = btn.querySelector('.status-icon');
                    icon.innerHTML = '✓';
                    icon.className = "status-icon w-6 h-6 rounded-full bg-emerald-500 text-white flex items-center justify-center text-[10px] font-bold";
                } else {
                    this.score = Math.max(0, this.score - 0.5);
                    btn.classList.replace('border-slate-100', 'border-red-500');
                    btn.classList.add('bg-red-50', 'text-red-900');
                    const icon = btn.querySelector('.status-icon');
                    icon.innerHTML = '✗';
                    icon.className = "status-icon w-6 h-6 rounded-full bg-red-500 text-white flex items-center justify-center text-[10px] font-bold";
                    
                    buttons.forEach(b => {
                        const bVal = parseFloat(b.dataset.val);
                        if (Math.abs(bVal - correct) < 0.001) {
                            b.classList.remove('opacity-50');
                            b.classList.replace('border-slate-100', 'border-emerald-500');
                            b.classList.add('bg-emerald-50', 'text-emerald-900');
                            const bIcon = b.querySelector('.status-icon');
                            bIcon.innerHTML = '✓';
                            bIcon.className = "status-icon w-6 h-6 rounded-full border-2 border-emerald-500 text-emerald-500 flex items-center justify-center text-[10px] font-bold";
                        }
                    });
                }

                this.updateUI();
                this.showExplanation();
            }

            updateUI() {
                const scoreDisp = document.getElementById('score-display');
                scoreDisp.innerText = this.score.toFixed(1);
                scoreDisp.className = "text-2xl font-mono font-bold " + (this.score >= 5 ? 'text-emerald-500' : 'text-blue-600');
                
                const progress = (this.score / 10) * 100;
                document.getElementById('progress-bar').style.width = Math.min(progress, 100) + "%";
            }

            showExplanation() {
                const q = this.currentQuestion;
                const container = document.getElementById('explanation-content');
                
                let html = "<div><p class=\"font-bold mb-2\">1. Expresión física:</p><p class=\"text-sm\">Utilizamos la fórmula que rige el comportamiento de $" + q.template.symbol + "$: " +
                    "$$" + q.template.symbol + " = " + q.template.formula.split('[[').join('').split(']]').join('') + "$$</p></div>";

                html += "<div><p class=\"font-bold mb-2\">2. Método de comparación:</p>" +
                    "<p class=\"text-sm\">Dividimos la magnitud en el <span class=\"text-red-600 font-bold\">sistema modificado (2)</span> por la del <span class=\"text-blue-600 font-bold\">estado inicial (1)</span>:</p></div>";

                const sym = q.template.symbol;
                const v1 = (s) => this.fmtVar(s, 1);
                const v2 = (s) => this.fmtVar(s, 2);

                const getExpr = (idx) => {
                    let f = q.template.formula;
                    for (let v in q.template.vars) {
                        f = f.split("[[" + v + "]]").join(this.fmtVar(v, idx));
                    }
                    return f;
                };

                html += `<div class="bg-slate-50 p-4 rounded-xl my-4 overflow-x-auto text-lg">
                    $$\\frac{${v2(sym)}}{${v1(sym)}} = \\frac{${getExpr(2)}}{${getExpr(1)}}$$
                </div>`;

                html += "<p class=\"text-sm\">Sustituimos los cambios proporcionales realizados: ";
                let substList = [];
                for (let v in q.changes) {
                    if (q.changes[v].val !== 1) {
                        substList.push("$" + v2(v) + " = " + getLatexFrac(q.changes[v].val) + " " + v1(v) + "$");
                    } else {
                        substList.push("$" + v2(v) + " = " + v1(v) + "$");
                    }
                }
                html += substList.join(', ') + ".</p>";

                let numFactor = "";
                let denFactor = "";
                for (let v in q.changes) {
                    const power = q.template.powers[v];
                    const factor = q.changes[v].val;
                    if (factor === 1) continue;

                    let part = getLatexFrac(factor);
                    if (part.includes("frac")) part = "\\left(" + part + "\\right)";
                    
                    if (Math.abs(power) === 0.5) part = "\\sqrt{" + part + "}";
                    else if (Math.abs(power) === 1.5) part = "\\sqrt{{" + part + "}^3}";
                    else if (Math.abs(power) !== 1) part = part + "^{" + Math.abs(power) + "}";
                    
                    if (power > 0) numFactor += (numFactor ? ' \\cdot ' : '') + part;
                    else denFactor += (denFactor ? ' \\cdot ' : '') + part;
                }

                if (!numFactor) numFactor = "1";
                if (!denFactor) denFactor = "1";

                html += `<div class="bg-blue-50/50 p-4 rounded-xl my-4 overflow-x-auto text-blue-900 font-bold text-lg">
                    $$\\frac{${v2(sym)}}{${v1(sym)}} = \\frac{${numFactor}}{${denFactor}} = ${getLatexFrac(q.resultFactor)}$$
                </div>`;

                html += "<div><p class=\"font-bold mb-2\">3. Conclusión:</p>" +
                    "<p class=\"text-sm\">Tras cancelar constantes y variables idénticas, obtenemos el factor de escala exacto:" +
                    "$$" + v2(sym) + " = " + getLatexFrac(q.resultFactor) + " \\cdot " + v1(sym) + "$$</p></div>";

                container.innerHTML = html;
                document.getElementById('explanation-card').classList.remove('hidden');
                this.typeset();
                
                setTimeout(() => {
                    document.getElementById('explanation-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }

            typeset() {
                if (window.MathJax && typeof MathJax.typesetPromise === 'function') {
                    MathJax.typesetPromise().catch(err => console.log('MathJax Error:', err));
                }
            }
        }

        let game;
        window.onload = () => {
            game = new Game();
        };
    </script>
</body>
</html>

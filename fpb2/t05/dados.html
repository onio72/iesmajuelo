<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio Probabilidad 3D - FP Básica</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ocultar flechas en inputs numéricos */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        .scene { width: 60px; height: 60px; perspective: 300px; margin: 10px; }
        .cube {
            width: 100%; height: 100%; position: relative; transform-style: preserve-3d;
            transition: transform 1.5s cubic-bezier(0.17, 0.67, 0.83, 0.67);
        }
        .cube__face, .table-face {
            position: absolute; width: 60px; height: 60px; border: 2px solid #333;
            background: white; border-radius: 8px; display: grid;
            grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 5px; gap: 2px;
        }
        .table-face { position: relative; width: 40px; height: 40px; border-width: 1px; padding: 3px; gap: 1px; }
        .dot { width: 10px; height: 10px; background: #e11d48; border-radius: 50%; align-self: center; justify-self: center; visibility: hidden; }
        .table-face .dot { width: 6px; height: 6px; }
        
        /* Definición de caras */
        .face-1 { transform: rotateY(0deg) translateZ(30px); }
        .face-2 { transform: rotateY(90deg) translateZ(30px); }
        .face-3 { transform: rotateX(90deg) translateZ(30px); }
        .face-4 { transform: rotateX(-90deg) translateZ(30px); }
        .face-5 { transform: rotateY(-90deg) translateZ(30px); }
        .face-6 { transform: rotateY(180deg) translateZ(30px); }

        .f1 .d5, .f2 .d3, .f2 .d7, .f3 .d3, .f3 .d5, .f3 .d7,
        .f4 .d1, .f4 .d3, .f4 .d7, .f4 .d9, .f5 .d1, .f5 .d3, .f5 .d5, .f5 .d7, .f5 .d9,
        .f6 .d1, .f6 .d3, .f6 .d4, .f6 .d6, .f6 .d7, .f6 .d9 { visibility: visible; }

        .highlight-col { background-color: #fef2f2; border: 2px solid #ef4444 !important; }
        .correct-val { color: #ef4444 !important; font-weight: bold; border: 2px solid #ef4444 !important; background-color: #fff1f2 !important; }
        .modal { background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; position: fixed; inset: 0; z-index: 50; }
    </style>
</head>
<body class="bg-slate-50 p-4">

    <div id="instructionModal" class="modal">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-md text-center border-t-8 border-red-600">
            <h2 class="text-2xl font-black text-slate-900 mb-4 uppercase">Aviso</h2>
            <p id="modalText" class="text-slate-600 mb-6"></p>
            <button onclick="closeModal()" class="bg-red-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-red-700 shadow-lg transition">OK</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
        <header class="bg-red-600 p-6 text-white text-center">
            <h1 class="text-3xl font-black uppercase tracking-tighter">Probabilidad: 8 Experimentos</h1>
        </header>

        <main class="p-6 md:p-10">
            <div class="flex flex-col items-center mb-10 bg-slate-50 p-6 rounded-2xl border border-slate-300">
                <div id="diceArea" class="flex flex-wrap justify-center gap-4 mb-8 min-h-[80px]"></div>
                <div class="text-center">
                    <button id="rollBtn" class="bg-slate-900 text-white px-10 py-4 rounded-2xl text-xl font-black hover:bg-slate-800 disabled:bg-slate-300 transition shadow-xl">
                        Lanzar 10 Dados
                    </button>
                    <p id="expStatus" class="mt-4 text-sm font-black uppercase text-red-600 tracking-widest">Experimento 1 de 8</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full border-collapse table-fixed">
                    <thead>
                        <tr class="bg-slate-200">
                            <th class="border-2 border-slate-300 p-3 text-[10px] uppercase w-16" rowspan="2">Cara</th>
                            <th class="border-2 border-slate-300 p-2 text-red-600 font-black uppercase" colspan="8">Experimento</th>
                            <th class="border-2 border-slate-300 p-1 bg-slate-300 text-[10px] uppercase w-16" rowspan="2">Suma</th>
                            <th class="border-2 border-slate-300 p-1 bg-slate-300 text-[10px] uppercase w-24" rowspan="2">%</th>
                        </tr>
                        <tr class="bg-slate-100">
                            <script>for(let i=1; i<=8; i++) document.write(`<th id="th-exp-${i}" class="border-2 border-slate-300 p-1 w-14 text-sm">${i}</th>`);</script>
                        </tr>
                    </thead>
                    <tbody id="mainTableBody">
                        <script>
                            const dotArray = Array(9).fill().map((_,i)=>`<div class="dot d${i+1}"></div>`).join('');
                            for(let i=1; i<=6; i++) {
                                document.write(`<tr>
                                    <td class="border-2 border-slate-300 p-1 bg-slate-50">
                                        <div class="flex justify-center"><div class="table-face f${i}">${dotArray}</div></div>
                                    </td>`);
                                for(let j=1; j<=8; j++) {
                                    document.write(`<td class="border-2 border-slate-300 p-0">
                                        <input type="number" id="input-${i}-${j}" min="0" disabled class="w-full h-full p-2 text-center text-lg outline-none disabled:bg-slate-100">
                                    </td>`);
                                }
                                document.write(`
                                    <td class="border-2 border-slate-300 p-0"><input type="number" id="sum-${i}" min="0" disabled class="w-full p-1 text-center font-bold bg-yellow-50 focus:bg-white outline-none"></td>
                                    <td class="border-2 border-slate-300 p-0"><input type="number" step="0.01" id="perc-${i}" min="0" disabled class="w-full p-1 text-center bg-yellow-50 focus:bg-white outline-none" placeholder="0.00"></td>
                                </tr>`);
                            }
                        </script>
                        <tr class="bg-slate-100 font-bold">
                            <td class="border-2 border-slate-300 p-2 text-center text-xs uppercase">Total</td>
                            <td colspan="8" class="border-2 border-slate-300 bg-slate-50"></td>
                            <td class="border-2 border-slate-300 p-0"><input type="number" id="totalSum" min="0" disabled class="w-full p-1 text-center font-bold bg-yellow-100 focus:bg-white outline-none" placeholder="?"></td>
                            <td class="border-2 border-slate-300 bg-slate-100"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="mt-8 flex justify-between items-center">
                <div id="liveScore" class="text-sm font-bold text-slate-500">Puntuación: 0.00 / 10</div>
                <button id="btnAction" onclick="handleAction()" class="bg-red-600 text-white px-8 py-4 rounded-2xl font-black hover:bg-red-700 shadow-lg uppercase tracking-tighter">Verificar Columna</button>
            </div>
        </main>
    </div>

    <script>
        let currentExp = 1, lastDiceResults = [], canRoll = true, phase = 'collecting';
        let successes = 0, failures = 0;
        const totalItems = 61; // 48 conteos + 7 sumas + 6 porcentajes
        const stepValue = 10 / totalItems;

        const rotations = { 1: 'rotateY(0deg)', 2: 'rotateY(-90deg)', 3: 'rotateX(-90deg)', 4: 'rotateX(90deg)', 5: 'rotateY(90deg)', 6: 'rotateY(180deg)' };

        function updateScoreUI() {
            const raw = (successes * stepValue) - (failures * stepValue);
            const final = Math.max(0, Math.min(10, raw)).toFixed(2);
            document.getElementById('liveScore').innerText = `Puntuación: ${final} / 10`;
            return final;
        }

        document.getElementById('rollBtn').onclick = function() {
            if(!canRoll || currentExp > 8) return;
            const area = document.getElementById('diceArea');
            area.innerHTML = ''; lastDiceResults = [];
            
            for(let i=0; i<10; i++) {
                const val = Math.floor(Math.random() * 6) + 1;
                lastDiceResults.push(val);
                const scene = document.createElement('div'); scene.className = 'scene';
                const cube = document.createElement('div'); cube.className = 'cube';
                for(let f=1; f<=6; f++) cube.innerHTML += `<div class="cube__face face-${f} f${f}">${dotArray}</div>`;
                scene.appendChild(cube); area.appendChild(scene);
                setTimeout(() => { 
                    cube.style.transform = `rotateX(${720+Math.random()*360}deg) rotateY(${720+Math.random()*360}deg)`;
                    setTimeout(() => { cube.style.transform = rotations[val]; }, 500);
                }, 50);
            }
            canRoll = false; this.disabled = true;
            setTimeout(() => { 
                enableColumn(currentExp);
                showModal(`Experimento ${currentExp}: Cuenta y anota cuántas veces sale cada cara.`);
            }, 2000);
        };

        function enableColumn(n) {
            document.querySelectorAll('input').forEach(i => i.disabled = true);
            document.querySelectorAll('th, td').forEach(el => el.classList.remove('highlight-col'));
            for(let i=1; i<=6; i++) {
                const input = document.getElementById(`input-${i}-${n}`);
                input.disabled = false; input.parentElement.classList.add('highlight-col');
            }
            document.getElementById(`th-exp-${n}`).classList.add('highlight-col');
        }

        function handleAction() {
            if(phase === 'collecting') {
                const counts = [0,0,0,0,0,0,0];
                lastDiceResults.forEach(v => counts[v]++);
                let colSum = 0, colCorrect = true, colErrors = 0;
                
                for(let i=1; i<=6; i++) {
                    const el = document.getElementById(`input-${i}-${currentExp}`);
                    const val = parseInt(el.value) || 0;
                    colSum += val;
                    if(val !== counts[i]) { colCorrect = false; colErrors++; }
                }

                if(colSum === 10 && colCorrect) {
                    successes += 6; // 6 celdas de conteo
                    for(let i=1; i<=6; i++) document.getElementById(`input-${i}-${currentExp}`).classList.add('correct-val');
                    if(++currentExp <= 8) {
                        canRoll = true; document.getElementById('rollBtn').disabled = false;
                        document.getElementById('expStatus').innerText = `Experimento ${currentExp} de 8`;
                        updateScoreUI();
                        showModal("¡Correcto! Lanza los dados para el siguiente experimento.");
                    } else {
                        phase = 'sums'; 
                        document.querySelectorAll('th, td').forEach(el => el.classList.remove('highlight-col'));
                        document.getElementById('expStatus').innerText = "Cálculo de Sumas";
                        document.querySelectorAll('input').forEach(i => i.disabled = true);
                        for(let i=1; i<=6; i++) document.getElementById(`sum-${i}`).disabled = false;
                        document.getElementById('totalSum').disabled = false;
                        document.getElementById('btnAction').innerText = "Verificar Sumas";
                        updateScoreUI();
                        showModal("Conteos finalizados. Ahora calcula la suma de cada fila y la suma total de los 80 lanzamientos.");
                    }
                } else {
                    failures += colErrors;
                    updateScoreUI();
                    showModal("Error: La suma debe ser 10 y los valores deben coincidir con los dados.");
                }
            } else if (phase === 'sums') {
                let sumsOk = true, sumErrors = 0, sumSuccess = 0;
                let globalTotal = 0;
                
                for(let i=1; i<=6; i++) {
                    let realSum = 0; for(let j=1; j<=8; j++) realSum += parseInt(document.getElementById(`input-${i}-${j}`).value);
                    const userSum = parseInt(document.getElementById(`sum-${i}`).value);
                    globalTotal += realSum;
                    if(userSum === realSum) { sumSuccess++; document.getElementById(`sum-${i}`).classList.add('correct-val'); document.getElementById(`sum-${i}`).disabled = true; }
                    else { sumsOk = false; sumErrors++; }
                }
                
                const userTotal = parseInt(document.getElementById('totalSum').value);
                if(userTotal === 80) { sumSuccess++; document.getElementById('totalSum').classList.add('correct-val'); document.getElementById('totalSum').disabled = true; }
                else { sumsOk = false; sumErrors++; }

                successes += sumSuccess; failures += sumErrors;
                updateScoreUI();

                if(sumsOk) {
                    phase = 'percentages';
                    document.getElementById('expStatus').innerText = "Cálculo de Porcentajes";
                    for(let i=1; i<=6; i++) document.getElementById(`perc-${i}`).disabled = false;
                    document.getElementById('btnAction').innerText = "Finalizar Laboratorio";
                    showModal("Sumas correctas. Por último, calcula el porcentaje de cada cara (redondeando a la centésima).");
                } else showModal("Revisa las sumas resaltadas. Recuerda que el total de lanzamientos es 80.");

            } else {
                let percsOk = true, pErrors = 0, pSuccess = 0;
                for(let i=1; i<=6; i++) {
                    let realSum = 0; for(let j=1; j<=8; j++) realSum += parseInt(document.getElementById(`input-${i}-${j}`).value);
                    const uPerc = parseFloat(document.getElementById(`perc-${i}`).value);
                    const rPerc = parseFloat(((realSum / 80) * 100).toFixed(2));
                    if(uPerc === rPerc) { pSuccess++; document.getElementById(`perc-${i}`).classList.add('correct-val'); document.getElementById(`perc-${i}`).disabled = true; }
                    else { percsOk = false; pErrors++; }
                }
                successes += pSuccess; failures += pErrors;
                const finalGrade = updateScoreUI();
                if(percsOk) showModal(`¡Enhorabuena! Has completado el laboratorio. Calificación final: ${finalGrade} / 10`);
                else showModal("Revisa los porcentajes. Debes redondear a la centésima (2 decimales).");
            }
        }

        function showModal(text) { document.getElementById('modalText').innerText = text; document.getElementById('instructionModal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('instructionModal').classList.add('hidden'); }
        window.onload = () => showModal("Bienvenido. Lanza los dados para iniciar el Experimento 1.");
    </script>
</body>
</html>

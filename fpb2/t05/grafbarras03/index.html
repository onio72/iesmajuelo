<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Constructor Total de Gr치ficos - SCORM</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            overscroll-behavior: none;
            user-select: none;
            -webkit-user-select: none;
        }
        .chart-area { touch-action: manipulation; }
        .bar-transition { transition: height 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .ctrl-btn:active { transform: scale(0.9); }
        
        /* Estilos para etiquetas seleccionables */
        .tag-item { transition: all 0.2s; cursor: pointer; }
        .tag-item.selected { 
            background-color: #4f46e5; /* indigo-600 */
            color: white; 
            transform: scale(1.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tag-item.used {
            opacity: 0.5;
            pointer-events: none;
            background-color: #e2e8f0; /* slate-200 */
            color: #94a3b8; /* slate-400 */
        }
        
        /* Slot de etiqueta vac칤o */
        .label-slot {
            border: 2px dashed #cbd5e1;
            color: #94a3b8;
            transition: all 0.2s;
        }
        .label-slot.filled {
            border: 2px solid #4f46e5;
            background-color: #e0e7ff;
            color: #3730a3;
            border-style: solid;
        }
        .label-slot:hover { border-color: #6366f1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50 flex-none">
        <div class="max-w-5xl mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold text-indigo-600"><i class="fa-solid fa-compass-drafting mr-2"></i>Constructor Total</h1>
            </div>
            <div class="flex items-center gap-3 text-sm">
                <div class="bg-indigo-50 px-3 py-1 rounded-lg border border-indigo-100 flex flex-col items-center leading-tight">
                    <span class="text-[10px] uppercase font-bold text-indigo-400">Ronda</span>
                    <span id="round-display" class="font-bold text-indigo-700 text-base">1</span>
                </div>
                <div class="bg-emerald-50 px-3 py-1 rounded-lg border border-emerald-100 flex flex-col items-center leading-tight">
                    <span class="text-[10px] uppercase font-bold text-emerald-400">Puntos</span>
                    <span id="score-display" class="font-bold text-emerald-700 text-base">0.00</span>
                    <span class="text-[9px] text-emerald-600 font-semibold tracking-tighter">META: 10</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow p-4 md:p-6 max-w-5xl mx-auto w-full h-full flex flex-col lg:flex-row gap-6 overflow-hidden">
        
        <!-- Panel Izquierdo: Datos -->
        <div class="lg:w-1/3 flex flex-col gap-4 flex-none overflow-y-auto">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <h2 class="font-semibold text-slate-700 mb-2 text-sm flex items-center uppercase tracking-wide">
                    <i class="fa-solid fa-table mr-2 text-slate-400"></i> Datos a Representar
                </h2>
                <div class="overflow-hidden rounded-lg border border-slate-200">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-100 text-slate-600 uppercase text-xs">
                            <tr>
                                <th class="px-4 py-2 text-left">Categor칤a</th>
                                <th class="px-4 py-2 text-right">Valor</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="divide-y divide-slate-100 bg-white"></tbody>
                    </table>
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 text-xs text-blue-800">
                <p class="font-bold mb-2"><i class="fa-solid fa-wrench mr-1"></i> Herramientas:</p>
                <ol class="list-decimal pl-4 space-y-1">
                    <li>Usa <strong>A침adir Barra</strong> para crear columnas.</li>
                    <li>Selecciona una etiqueta del banco (abajo) y pulsa en el hueco bajo la barra.</li>
                    <li>Ajusta la altura con <strong>(+)</strong> y <strong>(-)</strong>.</li>
                </ol>
            </div>
            
            <!-- Banco de Etiquetas -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex-grow">
                <h3 class="font-semibold text-slate-700 mb-2 text-xs uppercase tracking-wide">Banco de Etiquetas</h3>
                <div id="tag-pool" class="flex flex-wrap gap-2">
                    <!-- JS genera etiquetas -->
                </div>
            </div>
        </div>

        <!-- Panel Derecho: Gr치fico -->
        <div class="lg:w-2/3 flex flex-col h-full min-h-[450px]">
            <div class="bg-white p-2 md:p-4 rounded-xl shadow-md border border-slate-200 flex-grow flex flex-col relative select-none">
                
                <div class="flex justify-between items-center mb-4 flex-none">
                    <h3 id="chart-title" class="font-bold text-slate-700 text-sm md:text-base">Gr치fico</h3>
                    <div class="flex gap-2">
                        <button onclick="Game.removeColumn()" class="bg-rose-100 text-rose-600 hover:bg-rose-200 px-3 py-1 rounded text-xs font-bold transition">
                            <i class="fa-solid fa-trash mr-1"></i> Quitar
                        </button>
                        <button onclick="Game.addColumn()" class="bg-indigo-100 text-indigo-600 hover:bg-indigo-200 px-3 py-1 rounded text-xs font-bold transition">
                            <i class="fa-solid fa-plus mr-1"></i> A침adir Barra
                        </button>
                    </div>
                </div>

                <!-- Chart Area -->
                <div class="relative w-full flex-grow chart-area pl-10 pb-40 pr-4" id="chart-area">
                    
                    <!-- Grid -->
                    <div id="grid-container" class="absolute inset-0 pointer-events-none z-0"></div>

                    <!-- Axes -->
                    <div class="absolute bottom-40 left-10 right-4 h-0.5 bg-slate-800 z-10"></div>
                    <div class="absolute top-0 bottom-40 left-10 w-0.5 bg-slate-800 z-10"></div>

                    <!-- Bars Container -->
                    <div id="bars-container" class="absolute top-0 bottom-40 left-10 right-4 flex items-end justify-around px-2 md:px-4 z-20 gap-2">
                        <!-- User created bars go here -->
                    </div>

                    <!-- Controls Container (Labels + Buttons) -->
                    <div id="controls-container" class="absolute bottom-0 h-40 left-10 right-4 flex items-start justify-around px-2 md:px-4 z-30 gap-2">
                        <!-- User created controls go here -->
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="mt-4 flex justify-end gap-3 flex-none">
                <button id="check-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform active:scale-95 flex items-center w-full md:w-auto justify-center">
                    <i class="fa-solid fa-check-circle mr-2"></i> Corregir
                </button>
                <button id="next-btn" class="hidden bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition transform active:scale-95 flex items-center w-full md:w-auto justify-center">
                    Siguiente <i class="fa-solid fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- Results Overlay -->
    <div id="results-overlay" class="fixed inset-0 bg-slate-900/90 z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">
            <div id="final-icon" class="text-6xl mb-4">游끥</div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">춰Objetivo Alcanzado!</h2>
            <div class="my-6">
                <p class="text-slate-500 text-sm uppercase font-bold">Nota Final</p>
                <div class="text-5xl font-black text-indigo-600" id="final-score">10</div>
            </div>
            <p id="scorm-status" class="text-xs text-slate-400 mb-6">Guardando datos...</p>
            <button onclick="location.reload()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold py-3 rounded-lg">
                Jugar de nuevo
            </button>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl transition-all duration-300 opacity-0 -translate-y-4 pointer-events-none z-50 text-sm font-medium">Feedback</div>

    <script>
        // --- SCORM API (Robust Moodle Fix) ---
        const SCORM = {
            API: null, version: '1.2',
            init: function() {
                try {
                    let win = window, attempts = 0;
                    while (win && attempts < 10) {
                        try { if (win.API_1484_11) { this.API = win.API_1484_11; this.version = '2004'; break; }
                              if (win.API) { this.API = win.API; this.version = '1.2'; break; }
                              if (win.parent && win.parent !== win) win = win.parent; else break;
                        } catch (e) { break; } attempts++;
                    }
                    if (this.API) {
                        this.version==='2004'?this.API.Initialize(""):this.API.LMSInitialize("");
                        this.setStatus("incomplete");
                    }
                } catch (e) {}
            },
            
            // GUARDADO PROGRESIVO IMPLEMENTADO AQU칈
            setScore: function(raw) {
                if (!this.API) return;
                try {
                    const s = raw.toFixed(2);
                    if (this.version==='2004') {
                        this.API.SetValue("cmi.score.min","0"); 
                        this.API.SetValue("cmi.score.max","10");
                        this.API.SetValue("cmi.score.raw",s); 
                        this.API.SetValue("cmi.score.scaled",raw/10);
                        this.API.Commit(""); // Guardado inmediato
                    } else {
                        // SCORM 1.2
                        this.API.LMSSetValue("cmi.core.score.min","0"); 
                        this.API.LMSSetValue("cmi.core.score.max","10");
                        this.API.LMSSetValue("cmi.core.score.raw",s); 
                        this.API.LMSCommit(""); // Guardado inmediato (Requisito Cr칤tico)
                    }
                } catch(e){}
            },
            
            setStatus: function(st) {
                if(!this.API)return;
                try {
                    if(this.version==='2004'){
                        this.API.SetValue("cmi.completion_status",st==='passed'||st==='failed'?'completed':st);
                        this.API.SetValue("cmi.success_status",st); 
                        this.API.Commit("");
                    } else {
                        this.API.LMSSetValue("cmi.core.lesson_status",st); 
                        this.API.LMSCommit("");
                    }
                } catch(e){}
            },
            
            // L칍GICA DE FINALIZACI칍N Y CIERRE SEGURO
            finish: function() {
                if(!this.API)return;
                try{
                    if(this.version==='1.2'){
                        // Requisito: Usar cadena vac칤a, nunca "logout"
                        this.API.LMSSetValue("cmi.core.exit",""); 
                        this.API.LMSCommit(""); // Commit final de seguridad
                        this.API.LMSFinish("");
                    } else {
                        this.API.SetValue("cmi.exit","normal"); 
                        this.API.Commit(""); 
                        this.API.Terminate("");
                    }
                }catch(e){}
            }
        };

        // --- GAME LOGIC ---
        const Game = {
            targetData: [], 
            userBars: [],   
            config: { maxY: 10, tolerance: 0.1, penalty: 0.5 },
            state: { round: 1, score: 0, selectedTag: null },
            
            themes: [
                { t: "Ventas", c: ["Norte", "Sur", "Este", "Oeste", "Centro", "Web"] },
                { t: "Animales", c: ["Perro", "Gato", "Pez", "Loro", "H치mster", "Tortuga"] },
                { t: "Comida", c: ["Pizza", "Pasta", "Sushi", "Tacos", "Burger", "Ensalada"] },
                { t: "Colores", c: ["Rojo", "Azul", "Verde", "Amarillo", "Rosa", "Negro"] }
            ],

            init: function() {
                SCORM.init();
                this.setupGlobalEvents();
                this.newRound();
            },

            setupGlobalEvents: function() {
                document.getElementById('check-btn').onclick = () => this.validate();
                document.getElementById('next-btn').onclick = () => this.nextRound();
            },

            newRound: function() {
                const theme = this.themes[Math.floor(Math.random() * this.themes.length)];
                const numCols = Math.floor(Math.random() * 3) + 3; 
                const cats = [...theme.c].sort(() => 0.5 - Math.random()).slice(0, numCols);
                
                this.targetData = cats.map(cat => ({
                    cat: cat,
                    val: Math.floor(Math.random() * 8) * 2 + 2
                }));

                const maxVal = Math.max(...this.targetData.map(d => d.val));
                this.config.maxY = Math.ceil((maxVal + 1) / 5) * 5;

                this.userBars = [];
                this.userBars.push({ height: 0, label: null });

                document.getElementById('chart-title').innerText = theme.t;
                document.getElementById('round-display').innerText = this.state.round;
                document.getElementById('check-btn').classList.remove('hidden');
                document.getElementById('next-btn').classList.add('hidden');
                this.state.selectedTag = null;

                this.renderTable();
                this.renderTagPool();
                this.renderChart();
            },

            // --- RENDERING ---
            renderTable: function() {
                const displayData = [...this.targetData].sort(() => Math.random() - 0.5);
                const tbody = document.getElementById('data-table-body');
                tbody.innerHTML = displayData.map(d => `
                    <tr><td class="px-4 py-2 font-medium text-slate-700">${d.cat}</td>
                        <td class="px-4 py-2 text-right font-bold text-indigo-600">${d.val}</td></tr>
                `).join('');
            },

            renderTagPool: function() {
                const pool = document.getElementById('tag-pool');
                const tags = this.targetData.map(d => d.cat).sort();
                
                pool.innerHTML = tags.map(tag => {
                    const isUsed = this.userBars.some(b => b.label === tag);
                    return `
                        <div onclick="Game.selectTag('${tag}')" 
                             class="tag-item px-3 py-1 bg-white border border-slate-300 rounded shadow-sm text-sm font-medium ${isUsed ? 'used' : ''} ${this.state.selectedTag === tag ? 'selected ring-2 ring-indigo-300' : ''}">
                            ${tag}
                        </div>
                    `;
                }).join('');
            },

            renderChart: function() {
                this.renderGrid();
                this.renderBarsAndControls();
            },

            renderGrid: function() {
                const container = document.getElementById('grid-container');
                container.innerHTML = '';
                container.style.bottom = "10rem"; 
                
                for(let i=0; i<=5; i++) {
                    const pct = (i/5) * 100;
                    const val = Math.round((this.config.maxY / 5) * i);
                    container.innerHTML += `
                        <div class="absolute left-10 right-4 border-b ${i===0?'border-transparent':'border-slate-200 border-dashed'}" style="bottom:${pct}%"></div>
                        <div class="absolute left-1 text-xs text-slate-400 w-8 text-right translate-y-1/2" style="bottom:${pct}%">${val}</div>
                    `;
                }
            },

            renderBarsAndControls: function() {
                const barCont = document.getElementById('bars-container');
                const ctrlCont = document.getElementById('controls-container');
                barCont.innerHTML = '';
                ctrlCont.innerHTML = '';

                this.userBars.forEach((bar, i) => {
                    const pct = (bar.height / this.config.maxY) * 100;
                    barCont.innerHTML += `
                        <div class="relative h-full w-full flex items-end justify-center">
                            <div id="bar-${i}" class="w-full mx-1 bg-indigo-400/90 rounded-t-md bar-transition shadow-sm relative" style="height: ${pct}%;"></div>
                            <div id="ghost-${i}" class="absolute bottom-0 w-full mx-1 border-t-4 border-emerald-500 border-dashed opacity-0 transition-opacity z-10"></div>
                        </div>
                    `;

                    const labelText = bar.label || '<i class="fa-solid fa-plus text-slate-300"></i>';
                    const slotClass = bar.label ? 'filled' : '';
                    
                    ctrlCont.innerHTML += `
                        <div class="w-full flex flex-col items-center gap-2 control-group-${i}">
                            <div onclick="Game.assignLabel(${i})" class="label-slot ${slotClass} w-full h-8 rounded flex items-center justify-center text-xs font-bold cursor-pointer overflow-hidden text-ellipsis whitespace-nowrap px-1 select-none">
                                ${labelText}
                            </div>
                            <div class="flex gap-1">
                                <button onclick="Game.adjustHeight(${i}, 1)" class="ctrl-btn w-8 h-8 rounded-full bg-indigo-100 hover:bg-indigo-200 text-indigo-600 font-bold flex items-center justify-center"><i class="fa-solid fa-plus"></i></button>
                                <button onclick="Game.adjustHeight(${i}, -1)" class="ctrl-btn w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 text-slate-500 font-bold flex items-center justify-center"><i class="fa-solid fa-minus"></i></button>
                            </div>
                        </div>
                    `;
                });
            },

            // --- INTERACCIONES ---
            addColumn: function() {
                if (this.userBars.length < 8) {
                    this.userBars.push({ height: 0, label: null });
                    this.renderChart();
                }
            },

            removeColumn: function() {
                if (this.userBars.length > 0) {
                    this.userBars.pop();
                    this.renderChart();
                    this.renderTagPool();
                }
            },

            selectTag: function(tag) {
                if (this.state.selectedTag === tag) {
                    this.state.selectedTag = null; 
                } else {
                    this.state.selectedTag = tag;
                }
                this.renderTagPool();
            },

            assignLabel: function(index) {
                if (this.state.selectedTag) {
                    this.userBars[index].label = this.state.selectedTag;
                    this.state.selectedTag = null; 
                    this.renderChart();
                    this.renderTagPool();
                } else if (this.userBars[index].label) {
                    this.userBars[index].label = null;
                    this.renderChart();
                    this.renderTagPool();
                } else {
                    this.toast("Selecciona primero una etiqueta del banco");
                }
            },

            adjustHeight: function(index, delta) {
                let h = this.userBars[index].height + delta;
                if (h < 0) h = 0;
                if (h > this.config.maxY) h = this.config.maxY;
                this.userBars[index].height = h;
                const pct = (h / this.config.maxY) * 100;
                document.getElementById(`bar-${index}`).style.height = `${pct}%`;
            },

            // --- VALIDACI칍N ---
            validate: function() {
                let hits = 0;
                let errors = 0;
                let totalTargets = this.targetData.length;

                if (this.userBars.length !== totalTargets) {
                    this.toast(`N칰mero de columnas incorrecto. Hay ${this.userBars.length}, deber칤an ser ${totalTargets}.`);
                    errors += Math.abs(this.userBars.length - totalTargets);
                }

                this.userBars.forEach((bar, i) => {
                    const barElem = document.getElementById(`bar-${i}`);
                    const slotElem = document.querySelector(`.control-group-${i} .label-slot`);
                    
                    document.querySelector(`.control-group-${i}`).classList.add('opacity-50', 'pointer-events-none');

                    if (!bar.label) {
                        slotElem.classList.add('bg-rose-100', 'border-rose-400');
                        errors++;
                        return;
                    }

                    const target = this.targetData.find(t => t.cat === bar.label);

                    if (target) {
                        const diff = Math.abs(bar.height - target.val);
                        if (diff <= this.config.tolerance) {
                            barElem.classList.replace('bg-indigo-400/90', 'bg-emerald-500');
                            slotElem.classList.replace('border-indigo-600', 'border-emerald-600');
                            slotElem.classList.add('bg-emerald-100', 'text-emerald-800');
                            hits++;
                        } else {
                            barElem.classList.replace('bg-indigo-400/90', 'bg-rose-500');
                            const ghost = document.getElementById(`ghost-${i}`);
                            ghost.style.height = `${(target.val / this.config.maxY) * 100}%`;
                            ghost.classList.remove('opacity-0');
                            errors++;
                        }
                    } else {
                        errors++;
                    }
                });

                const valPerHit = 2 / totalTargets;
                const points = (hits * valPerHit) - (errors * this.config.penalty);
                
                this.state.score += points;
                if (this.state.score < 0) this.state.score = 0;
                if (this.state.score > 10) this.state.score = 10;

                // GUARDADO PROGRESIVO ACTIVO
                SCORM.setScore(this.state.score);
                document.getElementById('score-display').innerText = this.state.score.toFixed(2);

                this.toast(`Resultado: +${hits} correctas, -${errors} errores`);

                document.getElementById('check-btn').classList.add('hidden');
                document.getElementById('next-btn').classList.remove('hidden');
            },

            nextRound: function() {
                if (this.state.score >= 10) {
                    this.finishGame();
                } else {
                    this.state.round++;
                    this.newRound();
                }
            },

            finishGame: function() {
                const final = this.state.score.toFixed(2);
                document.getElementById('final-score').innerText = final;
                document.getElementById('results-overlay').classList.remove('hidden');
                SCORM.setScore(parseFloat(final));
                SCORM.setStatus("passed");
                SCORM.finish();
            },

            toast: function(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.classList.remove('opacity-0', '-translate-y-4');
                setTimeout(() => t.classList.add('opacity-0', '-translate-y-4'), 3000);
            }
        };

        window.onload = () => Game.init();
        
        // Listener de seguridad para cierre de pesta침a (Requisito Cr칤tico)
        window.addEventListener('unload', () => SCORM.finish());
    </script>
</body>
</html>

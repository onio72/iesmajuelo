<!DOCTYPE html>
<html lang=es>
<head>
    <meta charset=UTF-8>
    <meta name=viewport content="width=device-width, initial-scale=1.0">
    <title>Tabla Periódica Interactiva</title>
    <!-- Tailwind CSS -->
    <script src=https://cdn.tailwindcss.com></script>

    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .periodic-grid {
            display: grid;
            grid-template-columns: 30px repeat(18, minmax(32px, 50px));
            grid-template-rows: 30px repeat(7, auto);
            gap: 4px;
            width: max-content;
        }
        @media (max-width: 768px) {
            .periodic-grid {
                grid-template-columns: 20px repeat(18, minmax(20px, 30px));
                gap: 2px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-800">

    <div id=app class="w-full flex flex-col items-center min-h-screen"></div>

    <script>
        // --- LÓGICA DE COMUNICACIÓN SCORM 1.2 INTEGRADA ---
        let scormApi = null;
        function findScormApi(win) {
            let n = 0;
            try {
                while ((win.API == null) && (win.parent != null) && (win.parent != win) && (n < 10)) {
                    n++; win = win.parent;
                }
                return win.API;
            } catch (e) { return null; }
        }

        function initScorm() {
            scormApi = findScormApi(window);
            if (scormApi) {
                try {
                    scormApi.LMSInitialize("");
                    scormApi.LMSSetValue("cmi.core.score.min", "0");
                    scormApi.LMSSetValue("cmi.core.score.max", "10");
                    scormApi.LMSCommit("");
                } catch (e) {}
            }
        }

        function scormSetScoreAndComplete(score) {
            if (scormApi) {
                try {
                    scormApi.LMSSetValue("cmi.core.score.raw", score.toFixed(1));
                    if (score >= 5) scormApi.LMSSetValue("cmi.core.lesson_status", "passed");
                    scormApi.LMSCommit("");
                } catch (e) {}
            }
        }

        // --- DATOS DE LOS ELEMENTOS ---
        const elementsData = [
            { number: 1, symbol: 'H', name: 'Hidrógeno', mass: 1.008, group: 1, period: 1, col: 1, row: 1, type: 'no metal' },
            { number: 2, symbol: 'He', name: 'Helio', mass: 4.003, group: 18, period: 1, col: 18, row: 1, type: 'gas noble' },
            { number: 3, symbol: 'Li', name: 'Litio', mass: 6.94, group: 1, period: 2, col: 1, row: 2, type: 'metal' },
            { number: 4, symbol: 'Be', name: 'Berilio', mass: 9.012, group: 2, period: 2, col: 2, row: 2, type: 'metal' },
            { number: 5, symbol: 'B', name: 'Boro', mass: 10.81, group: 13, period: 2, col: 13, row: 2, type: 'semimetal' },
            { number: 6, symbol: 'C', name: 'Carbono', mass: 12.01, group: 14, period: 2, col: 14, row: 2, type: 'no metal' },
            { number: 7, symbol: 'N', name: 'Nitrógeno', mass: 14.01, group: 15, period: 2, col: 15, row: 2, type: 'no metal' },
            { number: 8, symbol: 'O', name: 'Oxígeno', mass: 16.00, group: 16, period: 2, col: 16, row: 2, type: 'no metal' },
            { number: 9, symbol: 'F', name: 'Flúor', mass: 19.00, group: 17, period: 2, col: 17, row: 2, type: 'no metal' },
            { number: 10, symbol: 'Ne', name: 'Neón', mass: 20.18, group: 18, period: 2, col: 18, row: 2, type: 'gas noble' },
            { number: 11, symbol: 'Na', name: 'Sodio', mass: 22.99, group: 1, period: 3, col: 1, row: 3, type: 'metal' },
            { number: 12, symbol: 'Mg', name: 'Magnesio', mass: 24.31, group: 2, period: 3, col: 2, row: 3, type: 'metal' },
            { number: 13, symbol: 'Al', name: 'Aluminio', mass: 26.98, group: 13, period: 3, col: 13, row: 3, type: 'metal' },
            { number: 14, symbol: 'Si', name: 'Silicio', mass: 28.09, group: 14, period: 3, col: 14, row: 3, type: 'semimetal' },
            { number: 15, symbol: 'P', name: 'Fósforo', mass: 30.97, group: 15, period: 3, col: 15, row: 3, type: 'no metal' },
            { number: 16, symbol: 'S', name: 'Azufre', mass: 32.06, group: 16, period: 3, col: 16, row: 3, type: 'no metal' },
            { number: 17, symbol: 'Cl', name: 'Cloro', mass: 35.45, group: 17, period: 3, col: 17, row: 3, type: 'no metal' },
            { number: 18, symbol: 'Ar', name: 'Argón', mass: 39.95, group: 18, period: 3, col: 18, row: 3, type: 'gas noble' },
            { number: 19, symbol: 'K', name: 'Potasio', mass: 39.10, group: 1, period: 4, col: 1, row: 4, type: 'metal' },
            { number: 20, symbol: 'Ca', name: 'Calcio', mass: 40.08, group: 2, period: 4, col: 2, row: 4, type: 'metal' },
            { number: 26, symbol: 'Fe', name: 'Hierro', mass: 55.85, group: 8, period: 4, col: 8, row: 4, type: 'metal' },
            { number: 27, symbol: 'Co', name: 'Cobalto', mass: 58.93, group: 9, period: 4, col: 9, row: 4, type: 'metal' },
            { number: 28, symbol: 'Ni', name: 'Níquel', mass: 58.69, group: 10, period: 4, col: 10, row: 4, type: 'metal' },
            { number: 29, symbol: 'Cu', name: 'Cobre', mass: 63.55, group: 11, period: 4, col: 11, row: 4, type: 'metal' },
            { number: 30, symbol: 'Zn', name: 'Cinc', mass: 65.38, group: 12, period: 4, col: 12, row: 4, type: 'metal' },
            { number: 31, symbol: 'Ga', name: 'Galio', mass: 69.72, group: 13, period: 4, col: 13, row: 4, type: 'metal' },
            { number: 32, symbol: 'Ge', name: 'Germanio', mass: 72.63, group: 14, period: 4, col: 14, row: 4, type: 'semimetal' },
            { number: 33, symbol: 'As', name: 'Arsénico', mass: 74.92, group: 15, period: 4, col: 15, row: 4, type: 'semimetal' },
            { number: 34, symbol: 'Se', name: 'Selenio', mass: 78.96, group: 16, period: 4, col: 16, row: 4, type: 'no metal' },
            { number: 35, symbol: 'Br', name: 'Bromo', mass: 79.90, group: 17, period: 4, col: 17, row: 4, type: 'no metal' },
            { number: 36, symbol: 'Kr', name: 'Kriptón', mass: 83.80, group: 18, period: 4, col: 18, row: 4, type: 'gas noble' },
            { number: 37, symbol: 'Rb', name: 'Rubidio', mass: 85.47, group: 1, period: 5, col: 1, row: 5, type: 'metal' },
            { number: 38, symbol: 'Sr', name: 'Estroncio', mass: 87.62, group: 2, period: 5, col: 2, row: 5, type: 'metal' },
            { number: 46, symbol: 'Pd', name: 'Paladio', mass: 106.42, group: 10, period: 5, col: 10, row: 5, type: 'metal' },
            { number: 47, symbol: 'Ag', name: 'Plata', mass: 107.87, group: 11, period: 5, col: 11, row: 5, type: 'metal' },
            { number: 48, symbol: 'Cd', name: 'Cadmio', mass: 112.41, group: 12, period: 5, col: 12, row: 5, type: 'metal' },
            { number: 49, symbol: 'In', name: 'Indio', mass: 114.82, group: 13, period: 5, col: 13, row: 5, type: 'metal' },
            { number: 50, symbol: 'Sn', name: 'Estaño', mass: 118.71, group: 14, period: 5, col: 14, row: 5, type: 'metal' },
            { number: 51, symbol: 'Sb', name: 'Antimonio', mass: 121.76, group: 15, period: 5, col: 15, row: 5, type: 'semimetal' },
            { number: 52, symbol: 'Te', name: 'Teluro', mass: 127.60, group: 16, period: 5, col: 16, row: 5, type: 'semimetal' },
            { number: 53, symbol: 'I', name: 'Yodo', mass: 126.90, group: 17, period: 5, col: 17, row: 5, type: 'no metal' },
            { number: 54, symbol: 'Xe', name: 'Xenón', mass: 131.29, group: 18, period: 5, col: 18, row: 5, type: 'gas noble' },
            { number: 55, symbol: 'Cs', name: 'Cesio', mass: 132.91, group: 1, period: 6, col: 1, row: 6, type: 'metal' },
            { number: 56, symbol: 'Ba', name: 'Bario', mass: 137.33, group: 2, period: 6, col: 2, row: 6, type: 'metal' },
            { number: 78, symbol: 'Pt', name: 'Platino', mass: 195.08, group: 10, period: 6, col: 10, row: 6, type: 'metal' },
            { number: 79, symbol: 'Au', name: 'Oro', mass: 196.97, group: 11, period: 6, col: 11, row: 6, type: 'metal' },
            { number: 80, symbol: 'Hg', name: 'Mercurio', mass: 200.59, group: 12, period: 6, col: 12, row: 6, type: 'metal' },
            { number: 81, symbol: 'Tl', name: 'Talio', mass: 204.38, group: 13, period: 6, col: 13, row: 6, type: 'metal' },
            { number: 82, symbol: 'Pb', name: 'Plomo', mass: 207.20, group: 14, period: 6, col: 14, row: 6, type: 'metal' },
            { number: 83, symbol: 'Bi', name: 'Bismuto', mass: 208.98, group: 15, period: 6, col: 15, row: 6, type: 'metal' },
            { number: 84, symbol: 'Po', name: 'Polonio', mass: 209.00, group: 16, period: 6, col: 16, row: 6, type: 'semimetal' },
            { number: 85, symbol: 'At', name: 'Astato', mass: 210.00, group: 17, period: 6, col: 17, row: 6, type: 'no metal' },
            { number: 86, symbol: 'Rn', name: 'Radón', mass: 222.00, group: 18, period: 6, col: 18, row: 6, type: 'gas noble' },
            { number: 87, symbol: 'Fr', name: 'Francio', mass: 223.00, group: 1, period: 7, col: 1, row: 7, type: 'metal' },
            { number: 88, symbol: 'Ra', name: 'Radio', mass: 226.00, group: 2, period: 7, col: 2, row: 7, type: 'metal' },
        ];

        // --- ESTADO ---
        let currentState = {
            view: 'init', 
            selectedElement: null,
            randoms: null,
            answers: {},
            results: null,
            showSolution: false,
            elementScores: {} // Registro de la mejor puntuación obtenida por elemento
        };

        // --- UTILIDADES ---
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        const normalizeStr = (str) => {
            return str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim() : "";
        };

        const normalizeNumericString = (raw) => {
            if (raw === null || raw === undefined) return null;
            let s = raw.toString().trim().replace(/[\s']/g, '');
            const lastDot = s.lastIndexOf('.');
            const lastComma = s.lastIndexOf(',');
            if (lastDot !== -1 && lastComma !== -1) {
                if (lastDot > lastComma) s = s.replace(/,/g, '');
                else s = s.replace(/\./g, '').replace(',', '.');
            } else if (lastComma !== -1) {
                const digitsAfter = s.length - lastComma - 1;
                if (digitsAfter !== 3) s = s.replace(',', '.');
                else s = s.replace(',', '');
            }
            return s;
        };

        const checkAnswer = (inputVal, targetVal, tolerancePercent = 0.05) => {
            const target = Number(targetVal);
            if (!Number.isFinite(target)) return false;
            const norm = normalizeNumericString(inputVal);
            if (norm === null) return false;
            const parsed = Number(norm);
            if (!Number.isFinite(parsed)) return false;
            if (target === 0) return Math.abs(parsed) <= tolerancePercent;
            const relError = Math.abs(parsed - target) / Math.abs(target);
            return relError <= tolerancePercent;
        };

        const pickRandomElement = () => elementsData[Math.floor(Math.random() * elementsData.length)];

        const generateRandoms = () => {
            return {
                n1: Math.floor(Math.random() * 10) * 10 + 10,
                n2: Math.floor(Math.random() * 19) * 500 + 1000,
                y: (Math.floor(Math.random() * 199) + 1) / 10,
                q4UnitOpts: shuffleArray(['u', 'g', 'kg']),
                q7UnitOpts: shuffleArray(['u', 'u/mol', 'g', 'g/mol', 'kg', 'kg/mol']),
                q9Opts: shuffleArray(['Metal', 'No metal', 'Semimetal', 'Gas Noble'])
            };
        };

        const app = document.getElementById('app');

        function render() {
            app.innerHTML = '';
            if (currentState.view === 'init') renderTable(true);
            else if (currentState.view === 'quiz') renderQuiz();
            else if (currentState.view === 'consulting') renderTable(false);
        }

        function calculateCumulativeGrade() {
            let totalWeightedScore = 0;
            for (let symbol in currentState.elementScores) {
                // Cada elemento aporta proporcionalmente a 1.5 puntos
                totalWeightedScore += (currentState.elementScores[symbol] / 11) * 1.5;
            }
            return Math.min(10, totalWeightedScore);
        }

        function renderTable(isIntro) {
            const header = document.createElement('header');
            header.className = 'mb-4 text-center mt-8 animate-fade-in px-4';
            if (isIntro) {
                const cumulativeGrade = calculateCumulativeGrade();
                const gradeColor = cumulativeGrade < 5 ? 'text-red-600' : 'text-green-600';
                
                header.innerHTML = `
                    <h1 class="text-3xl font-bold text-green-700 mb-4">Tabla Periódica Interactiva</h1>
                    <div class="bg-white border-l-4 border-blue-500 p-4 rounded shadow-md max-w-xl mx-auto">
                        <p class="font-bold text-lg">Cada respuesta correcta suma puntos. ¡Necesitas un 6.0 para aprobar!</p>
                        <p class="text-sm mt-2">Calificación actual: <strong class="text-2xl ${gradeColor}">${cumulativeGrade.toFixed(1)}</strong></p>
                    </div>
                `;
            } else {
                header.innerHTML = `
                    <h1 class="text-2xl font-bold text-gray-700 mb-2">Consulta de Tabla</h1>
                    <button onclick="goToQuiz()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded shadow transition-colors flex items-center gap-2 mx-auto">Volver</button>
                `;
            }
            app.appendChild(header);

            const container = document.createElement('div');
            container.className = 'overflow-x-auto w-full flex justify-center pb-8 px-2 animate-fade-in';
            const grid = document.createElement('div');
            grid.className = 'periodic-grid bg-white p-4 rounded shadow-xl border border-gray-300 relative';
            
            elementsData.forEach(el => {
                const hasBeenAttempted = currentState.elementScores[el.symbol] !== undefined;
                const tile = document.createElement('div');
                tile.className = `border-2 border-white rounded flex flex-col items-center justify-center p-1 shadow-sm ${hasBeenAttempted ? 'bg-green-500 text-white font-bold' : 'bg-green-300 opacity-80'}`;
                tile.style.gridColumn = el.col + 1; tile.style.gridRow = el.row + 1; tile.style.aspectRatio = '1/1';
                tile.innerHTML = `<span class="text-[10px] font-semibold self-start ml-1 leading-none">${el.number}</span><span class="text-sm leading-none">${el.symbol}</span>`;
                grid.appendChild(tile);
            });
            container.appendChild(grid);
            app.appendChild(container);
        }

        function renderQuiz() {
            const el = currentState.selectedElement;
            const r = currentState.randoms;
            const res = currentState.results;
            const container = document.createElement('div');
            container.className = 'max-w-4xl w-full mx-auto p-4 animate-fade-in';

            const cumulativeGrade = calculateCumulativeGrade();
            const gradeColor = cumulativeGrade < 5 ? 'text-red-600' : 'text-green-600';

            const topBar = document.createElement('div');
            topBar.className = 'flex justify-between items-center mb-6';
            const consultBtn = document.createElement('button');
            consultBtn.className = 'text-blue-600 font-semibold bg-white px-3 py-2 rounded shadow border border-blue-100';
            consultBtn.innerHTML = `Consultar Tabla`;
            consultBtn.onclick = () => { currentState.view = 'consulting'; render(); };
            topBar.appendChild(consultBtn);
            container.appendChild(topBar);

            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 md:grid-cols-3 gap-8';

            const leftCol = document.createElement('div');
            leftCol.className = 'md:col-span-1 flex flex-col items-center';
            leftCol.innerHTML = `
                <div class="sticky top-4 w-full flex flex-col items-center">
                    <div class="w-48 h-56 bg-white border-4 border-gray-300 shadow-xl rounded-lg flex flex-col p-4 relative mx-auto">
                        <div class="absolute top-2 left-2 text-2xl text-gray-600 font-sans">${el.number}</div>
                        <div class="flex-grow flex items-center justify-center"><span class="text-7xl font-bold text-gray-800">${el.symbol}</span></div>
                        <div class="text-center border-t-2 border-gray-200 pt-2"><span class="text-xl font-mono text-gray-700">${el.mass.toFixed(2)}</span></div>
                    </div>
                    <div class="mt-6 p-4 bg-white rounded-lg shadow border-t-4 border-blue-500 text-center w-full">
                        <div class="text-xs text-gray-500 uppercase tracking-wide">Calificación Acumulada</div>
                        <div class="text-5xl font-bold ${gradeColor}">${cumulativeGrade.toFixed(1)}</div>
                    </div>
                </div>
            `;
            grid.appendChild(leftCol);

            const rightCol = document.createElement('div');
            rightCol.className = 'md:col-span-2 bg-white p-6 rounded-lg shadow-md border border-gray-200';
            rightCol.innerHTML = `<h1 class="text-2xl font-bold mb-6 text-gray-800 border-b pb-2">Cuestionario: ${el.symbol}</h1>`;
            
            const form = document.createElement('div');
            form.className = 'space-y-6';

            const createInputGroup = (label, id, suffix = '') => {
                const div = document.createElement('div');
                div.innerHTML = `<label class="block font-semibold mb-1 text-gray-700">${label}</label>`;
                const wrapper = document.createElement('div'); wrapper.className = 'flex items-center gap-2';
                const input = document.createElement('input'); input.className = 'w-full border p-2 rounded';
                input.disabled = !!res; input.value = currentState.answers[id] || '';
                input.oninput = (e) => currentState.answers[id] = e.target.value;
                wrapper.appendChild(input);
                if (suffix) { const s = document.createElement('span'); s.textContent = suffix; wrapper.appendChild(s); }
                div.appendChild(wrapper);
                if (res && res.feedback[id]) {
                    const fb = res.feedback[id];
                    div.innerHTML += `<div class="mt-1 text-sm ${fb.correct ? 'text-green-600' : 'text-red-600'} font-medium">
                        ${fb.correct ? '✓ ¡Correcto!' : '✗ Respuesta: ' + fb.answer}</div>`;
                }
                return div;
            };

            const createCombinedGroup = (label, inputId, selectId, selectOptions) => {
                const div = document.createElement('div');
                div.innerHTML = `<label class="block font-semibold mb-1 text-gray-700">${label}</label>`;
                const row = document.createElement('div'); row.className = 'flex gap-2';
                const input = document.createElement('input'); input.className = 'flex-1 border p-2 rounded';
                input.disabled = !!res; input.value = currentState.answers[inputId] || '';
                input.oninput = (e) => currentState.answers[inputId] = e.target.value;
                const select = document.createElement('select'); select.className = 'w-1/3 border p-2 rounded bg-white';
                select.disabled = !!res; select.innerHTML = '<option value="">Unidad</option>';
                selectOptions.forEach(opt => { const o = document.createElement('option'); o.value = opt; o.text = opt; if (currentState.answers[selectId] === opt) o.selected = true; select.appendChild(o); });
                select.onchange = (e) => currentState.answers[selectId] = e.target.value;
                row.appendChild(input); row.appendChild(select); div.appendChild(row);
                if (res) {
                    const fbV = res.feedback[inputId]; const fbU = res.feedback[selectId];
                    if (fbV && fbU) div.innerHTML += `<div class="mt-1 text-sm ${fbV.correct && fbU.correct ? 'text-green-600' : 'text-red-600'} font-medium">Respuesta: ${fbV.answer} ${fbU.answer}</div>`;
                }
                return div;
            };

            const createSelectGroup = (label, id, options) => {
                const div = document.createElement('div');
                div.innerHTML = `<label class="block font-semibold mb-1 text-gray-700">${label}</label>`;
                const select = document.createElement('select'); select.className = 'w-full border p-2 rounded bg-white';
                select.disabled = !!res; select.innerHTML = '<option value="">Selección...</option>';
                options.forEach(opt => { const o = document.createElement('option'); o.value = opt; o.text = opt; if (currentState.answers[id] === opt) o.selected = true; select.appendChild(o); });
                select.onchange = (e) => currentState.answers[id] = e.target.value;
                div.appendChild(select);
                if (res && res.feedback[id]) div.innerHTML += `<div class="mt-1 text-sm ${res.feedback[id].correct ? 'text-green-600' : 'text-red-600'} font-medium">Respuesta: ${res.feedback[id].answer}</div>`;
                return div;
            };

            form.appendChild(createInputGroup('1. ¿Nombre del elemento?', 'q1'));
            form.appendChild(createInputGroup('2. ¿Número de orden?', 'q2'));
            form.appendChild(createInputGroup('3. ¿Número de protones?', 'q3'));
            form.appendChild(createCombinedGroup(`4. ¿Masa promedio de un átomo de ${el.symbol}?`, 'q4_val', 'q4_unit', r.q4UnitOpts));
            form.appendChild(createInputGroup(`5. ¿Masa de ${r.n1} átomos?`, 'q5', 'u'));
            form.appendChild(createInputGroup(`6. ¿Masa de ${r.n2} átomos?`, 'q6', 'u'));
            form.appendChild(createCombinedGroup(`7. ¿Masa molar de ${el.symbol}?`, 'q7_val', 'q7_unit', r.q7UnitOpts));
            form.appendChild(createInputGroup(`8. ¿Masa de ${r.y.toFixed(1)} moles?`, 'q8', 'g'));
            form.appendChild(createSelectGroup('9. ¿A qué grupo pertenece?', 'q9', r.q9Opts));

            if (!res) {
                const submitBtn = document.createElement('button');
                submitBtn.className = 'w-full bg-green-600 text-white font-bold py-3 px-6 rounded shadow-lg text-lg';
                submitBtn.innerText = 'Corregir Respuestas';
                submitBtn.onclick = checkAnswers;
                form.appendChild(submitBtn);
            } else {
                const newBtn = document.createElement('button');
                newBtn.className = 'w-full bg-blue-600 text-white font-bold py-3 px-6 rounded shadow-lg text-lg mt-4';
                newBtn.innerText = 'Siguiente Elemento';
                newBtn.onclick = startNewGame;
                form.appendChild(newBtn);
            }

            rightCol.appendChild(form); grid.appendChild(rightCol); container.appendChild(grid); app.appendChild(container);
        }

        function startNewGame() {
            currentState.view = 'init'; currentState.results = null; currentState.answers = {};
            render();
            setTimeout(() => {
                currentState.selectedElement = pickRandomElement();
                currentState.randoms = generateRandoms();
                currentState.view = 'quiz'; render();
            }, 1500);
        }

        function goToQuiz() { currentState.view = 'quiz'; render(); }

        function checkAnswers() {
            const el = currentState.selectedElement;
            const ans = currentState.answers;
            const r = currentState.randoms;
            let currentExScore = 0; let feedback = {};
            const visualMass = Number(el.mass.toFixed(2));
            
            const check = (key, condition, correctVal) => { if (condition) currentExScore++; feedback[key] = { correct: condition, answer: correctVal }; };
            const checkNum = (key, inputVal, targetVal) => { const isValid = checkAnswer(inputVal, targetVal); check(key, isValid, targetVal.toFixed(2)); };

            check('q1', normalizeStr(ans['q1']) === normalizeStr(el.name), el.name);
            check('q2', parseInt(ans['q2']) === el.number, el.number);
            check('q3', parseInt(ans['q3']) === el.number, el.number);
            checkNum('q4_val', ans['q4_val'], visualMass);
            check('q4_unit', ans['q4_unit'] === 'u', 'u');
            checkNum('q5', ans['q5'], r.n1 * visualMass);
            checkNum('q6', ans['q6'], r.n2 * visualMass);
            checkNum('q7_val', ans['q7_val'], visualMass);
            check('q7_unit', ans['q7_unit'] === 'g/mol', 'g/mol');
            checkNum('q8', ans['q8'], r.y * visualMass);
            check('q9', normalizeStr(ans['q9']) === normalizeStr(el.type), el.type);

            // Almacenar el mejor resultado para este elemento
            const prevScore = currentState.elementScores[el.symbol] || 0;
            if (currentExScore > prevScore) {
                currentState.elementScores[el.symbol] = currentExScore;
            }

            currentState.results = { score: currentExScore, feedback };
            let cumulativeGrade = calculateCumulativeGrade();
            render();
            scormSetScoreAndComplete(cumulativeGrade);
        }

        window.onload = () => { initScorm(); startNewGame(); };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abundancia de Isótopos - Gráfico de Quesitos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e67e22;
            --bg-color: #f4f6f7;
            --card-bg: #ffffff;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #c0392b;
            --text-dark: #333333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1000px;
            width: 100%;
            justify-content: center;
        }

        .card {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-width: 250px;
            flex: 1;
            position: relative;
        }

        .chem-symbol-container {
            font-family: 'Times New Roman', serif;
            position: relative;
            font-size: 120px;
            line-height: 1;
            margin: 30px 0 30px 50px; 
            color: var(--primary-color);
            font-weight: bold;
            display: inline-block;
        }

        .atomic-number {
            position: absolute;
            bottom: 5px;
            left: -85px; 
            font-size: 40px;
            width: 80px;
            text-align: right;
        }

        .mass-number {
            position: absolute;
            top: 5px;
            left: -85px; 
            font-size: 40px;
            width: 80px;
            text-align: right;
            opacity: 0; 
            transition: opacity 0.3s ease;
        }

        .mass-number.visible { opacity: 1; }

        .chart-card {
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 20px;
            flex: 2;
            min-width: 300px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-around;
        }

        .chart-wrapper { position: relative; height: 300px; width: 300px; }

        .custom-legend { list-style: none; padding: 0; margin-left: 20px; max-height: 300px; overflow-y: auto; }
        .legend-item { display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; padding: 5px 10px; border-radius: 5px; transition: background 0.2s; }
        .legend-color { width: 15px; height: 15px; border-radius: 3px; margin-right: 10px; }

        .quiz-section {
            margin-top: 30px;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            width: 100%;
            max-width: 900px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .score-board { text-align: right; font-size: 1.5rem; margin-bottom: 20px; font-weight: bold; }
        .score-value.low { color: var(--error-color); }
        .score-value.high { color: var(--success-color); }

        .action-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            margin: 5px;
        }

        .iso-btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .iso-select-btn { padding: 8px 16px; border-radius: 20px; cursor: pointer; border: 2px solid #bdc3c7; }
        .iso-select-btn.selected { background: var(--primary-color); color: white; }
        .feedback-msg { margin-top: 5px; font-weight: bold; }
        .feedback-msg.correct { color: var(--success-color); }
        .feedback-msg.incorrect { color: var(--error-color); }
        .feedback-msg.regular { color: var(--warning-color); }

        select, input[type=number] { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    </style>
</head>
<body>

    <h1>Abundancia Isotópica</h1>

    <div class="main-container">
        <div class="card">
            <div class="element-name" id="elementName">Cargando...</div>
            <div class="chem-symbol-container">
                <span class="mass-number" id="massNumber"></span>
                <span class="atomic-number" id="atomicNumber"></span>
                <span id="symbolText"></span>
            </div>
            <div id="isotopeInfo" style="margin-top:20px; font-weight:bold;">Pulsa en la leyenda para detalles</div>
        </div>

        <div class="chart-card">
            <div class="chart-wrapper">
                <canvas id="isotopeChart"></canvas>
            </div>
            <ul class="custom-legend" id="chartLegend"></ul>
        </div>
    </div>

    <div class="quiz-section">
        <div class="score-board">
            Puntuación: <span id="scoreValue" class="score-value low">0.00</span> / 10
        </div>
        <div id="questionsContainer"></div>
        <div style="margin-top: 20px; text-align: center;">
            <button id="checkBtn" class="action-btn" onclick="checkAnswers()">Corregir</button>
            <button id="nextBtn" class="action-btn" onclick="loadNextElement()" style="display:none;">Siguiente</button>
            <button id="restartBtn" class="action-btn" onclick="restartGame()" style="display:none; background-color: var(--success-color);">Reiniciar</button>
        </div>
    </div>

    <script>
        // --- 0. SCORM API WRAPPER CORREGIDO ---
        var SCORM = {
            API: null,
            init: function() {
                var api = this.getAPI();
                if (api) {
                    this.API = api;
                    this.API.LMSInitialize("");
                    this.API.LMSSetValue("cmi.core.score.min", "0");
                    this.API.LMSSetValue("cmi.core.score.max", "10");
                    this.API.LMSSetValue("cmi.core.lesson_status", "incomplete");
                    this.API.LMSCommit("");
                    console.log("SCORM: Conectado e Inicializado.");
                } else {
                    console.warn("SCORM: API no encontrada o bloqueada por seguridad. Modo local activado.");
                }
            },
            getAPI: function() {
                var findAPITries = 0;
                var win = window;
                try {
                    // Intentamos buscar la API subiendo por la jerarquía de ventanas (frames)
                    while ((win.API == null) && (win.parent != null) && (win.parent != win)) {
                        findAPITries++;
                        if (findAPITries > 10) return null;
                        win = win.parent;
                    }
                    return win.API;
                } catch (e) {
                    // Si hay un SecurityError por Cross-Origin, capturamos el error y devolvemos null
                    return null;
                }
            },
            setScore: function(score) {
                if (this.API) {
                    var formattedScore = score.toFixed(2);
                    this.API.LMSSetValue("cmi.core.score.raw", formattedScore);
                    this.API.LMSCommit("");
                }
            },
            setComplete: function() {
                if (this.API) {
                    this.API.LMSSetValue("cmi.core.lesson_status", "passed");
                    this.API.LMSCommit("");
                }
            },
            terminate: function() {
                if (this.API) this.API.LMSFinish("");
            }
        };

        const csvData = `Elemento,Simbolo,Masa_nominal,Masa_exacta,Abundancia
Hidrógeno,1H,1,1.00783,99.99
Hidrógeno,D/2H,2,2.01410,0.01
Carbono,12C,12,12.0000,98.91
Carbono,13C,13,13.0034,1.09
Nitrógeno,14N,14,14.0031,99.6
Nitrógeno,15N,15,15.0001,0.37
Oxígeno,16O,16,15.9949,99.76
Oxígeno,17O,17,16.9991,0.037
Oxígeno,18O,18,17.9992,0.20
Flúor,19F,19,18.9984,100
Silicio,28Si,28,27.9769,92.28
Silicio,29Si,29,28.9765,4.70
Silicio,30Si,30,29.9737,3.02
Azufre,32S,32,31.9721,95.02
Azufre,33S,33,32.9715,0.75
Azufre,34S,34,33.9679,4.21
Azufre,36S,36,35.9671,0.02
Cloro,35Cl,35,34.9689,75.77
Cloro,37Cl,37,36.9659,24.23
Bromo,79Br,79,78.9183,50.69
Bromo,81Br,81,80.9163,49.31
Hafnio,174Hf,174,173.940046,0.16
Hafnio,176Hf,176,175.941402,5.26
Hafnio,177Hf,177,176.94322,18.60
Hafnio,178Hf,178,177.943698,27.28
Hafnio,179Hf,179,178.945815,13.62
Hafnio,180Hf,180,179.946549,35.08
Tántalo,180Ta,180,179.947466,0.012
Tántalo,181Ta,181,180.947996,99.988
Wolframio,180W,180,179.946706,0.12
Wolframio,182W,182,181.948206,26.50
Wolframio,183W,183,182.950224,14.31
Wolframio,184W,184,183.950933,30.64
Wolframio,186W,186,185.954362,28.43
Renio,185Re,185,184.952957,37.40
Renio,187Re,187,186.955753,62.60`;

        const atomicNumbersMap = {
            'Hidrógeno': 1, 'Carbono': 6, 'Nitrógeno': 7, 'Oxígeno': 8, 'Flúor': 9,
            'Silicio': 14, 'Azufre': 16, 'Cloro': 17, 'Bromo': 35, 'Hafnio': 72,
            'Tántalo': 73, 'Wolframio': 74, 'Renio': 75
        };

        let parsedElements = {};
        let validElementKeys = [];
        let currentElementKey = '';
        let currentChart = null;
        let globalScore = 0.0;
        let selectedIsotopeForQ5 = null;

        function initData() {
            const lines = csvData.split('\n');
            for (let i = 1; i < lines.length; i++) {
                const p = lines[i].split(',');
                if (p.length < 5) continue;
                const name = p[0].trim();
                const symbol = p[1].trim().replace(/[0-9]/g, '').replace('D/', '').replace('/H', '');
                if (!parsedElements[name]) {
                    parsedElements[name] = { name, symbol, z: atomicNumbersMap[name] || 0, isotopes: [] };
                }
                parsedElements[name].isotopes.push({ fullSymbol: p[1].trim(), mass: parseInt(p[2]), abundance: parseFloat(p[4]) });
            }
            validElementKeys = Object.keys(parsedElements).filter(k => parsedElements[k].isotopes.length > 1);
        }

        function loadNextElement() {
            if (globalScore >= 10) { endGame(); return; }
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('checkBtn').style.display = 'inline-block';
            document.getElementById('checkBtn').disabled = false;

            let key;
            do { key = validElementKeys[Math.floor(Math.random() * validElementKeys.length)]; } while (key === currentElementKey && validElementKeys.length > 1);
            
            currentElementKey = key;
            const data = parsedElements[key];
            renderElement(data);
            generateQuiz(data);
        }

        function renderElement(data) {
            document.getElementById('elementName').innerText = data.name;
            document.getElementById('symbolText').innerText = data.symbol;
            document.getElementById('atomicNumber').innerText = data.z;
            document.getElementById('massNumber').classList.remove('visible');
            
            const labels = data.isotopes.map(i => i.fullSymbol);
            const abundances = data.isotopes.map(i => i.abundance);
            const ctx = document.getElementById('isotopeChart').getContext('2d');
            
            if (currentChart) currentChart.destroy();
            currentChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: abundances,
                        backgroundColor: ['#FFCE56', '#FF6384', '#36A2EB', '#FF9F40', '#4BC0C0', '#9b59b6']
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            const legend = document.getElementById('chartLegend');
            legend.innerHTML = '';
            data.isotopes.forEach((iso, idx) => {
                const li = document.createElement('li');
                li.className = 'legend-item';
                li.innerHTML = `<span class="legend-color" style="background:${currentChart.data.datasets[0].backgroundColor[idx]}"></span>
                                <span><sup>${iso.mass}</sup>${data.symbol}</span>`;
                li.onclick = () => {
                    const massEl = document.getElementById('massNumber');
                    massEl.innerText = iso.mass;
                    massEl.classList.add('visible');
                    document.getElementById('isotopeInfo').innerHTML = `Abundancia: ${iso.abundance}%`;
                };
                legend.appendChild(li);
            });
        }

        function generateQuiz(data) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            selectedIsotopeForQ5 = null;

            const mostAbundant = data.isotopes.reduce((prev, curr) => (prev.abundance > curr.abundance) ? prev : curr);
            const calcMass = data.isotopes.reduce((acc, iso) => acc + (iso.mass * iso.abundance), 0) / 100;

            container.innerHTML = `
                <div class="question-block" id="q1-block" data-correct="${data.isotopes.length}">
                    <p>1. Isótopos naturales del ${data.name}: <select id="input-1"><option value="">?</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></p>
                </div>
                <div class="question-block" id="q2-block" data-correct="${data.z}">
                    <p>2. Protones en el núcleo: <input type="number" id="input-2" style="width:60px"></p>
                </div>
                <div class="question-block" id="q5-block" data-correct="${mostAbundant.fullSymbol}">
                    <p>3. Selecciona el isótopo más abundante:</p>
                    <div class="iso-btn-group" id="btnGroup5"></div>
                </div>
                <div class="question-block" id="q7-block" data-correct="${calcMass}">
                    <p>4. Masa atómica promedio (usa 2 decimales): <input type="number" step="0.01" id="input-7"></p>
                </div>
            `;

            const btnGroup = document.getElementById('btnGroup5');
            data.isotopes.forEach(iso => {
                const btn = document.createElement('button');
                btn.className = 'iso-select-btn';
                btn.innerHTML = `<sup>${iso.mass}</sup>${data.symbol}`;
                btn.onclick = () => {
                    document.querySelectorAll('.iso-select-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    selectedIsotopeForQ5 = iso.fullSymbol;
                };
                btnGroup.appendChild(btn);
            });
        }

        function checkAnswers() {
            let roundPoints = 0;
            
            // Q1
            const q1 = document.getElementById('q1-block');
            const a1 = document.getElementById('input-1');
            if(a1.value == q1.dataset.correct) roundPoints += 1;
            a1.disabled = true;

            // Q2
            const q2 = document.getElementById('q2-block');
            const a2 = document.getElementById('input-2');
            if(a2.value == q2.dataset.correct) roundPoints += 1;
            a2.disabled = true;

            // Q5
            const q5 = document.getElementById('q5-block');
            if(selectedIsotopeForQ5 == q5.dataset.correct) roundPoints += 3;
            document.querySelectorAll('.iso-select-btn').forEach(b => b.disabled = true);

            // Q7
            const q7 = document.getElementById('q7-block');
            const a7 = document.getElementById('input-7');
            const diff = Math.abs(parseFloat(a7.value) - parseFloat(q7.dataset.correct));
            if(diff < 0.05) roundPoints += 5;
            else if(diff < 0.2) roundPoints += 2;
            a7.disabled = true;

            globalScore = Math.min(10, globalScore + (roundPoints / 2)); 
            updateUI();
            SCORM.setScore(globalScore);

            if (globalScore >= 10) endGame();
            else {
                document.getElementById('checkBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'inline-block';
            }
        }

        function updateUI() {
            const el = document.getElementById('scoreValue');
            el.innerText = globalScore.toFixed(2);
            el.className = 'score-value ' + (globalScore >= 5 ? 'high' : 'low');
        }

        function endGame() {
            SCORM.setScore(10);
            SCORM.setComplete();
            document.getElementById('questionsContainer').innerHTML = "<h2>¡Felicidades! Has completado el ejercicio con éxito.</h2>";
            document.getElementById('checkBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('restartBtn').style.display = 'inline-block';
        }

        function restartGame() {
            globalScore = 0;
            updateUI();
            document.getElementById('restartBtn').style.display = 'none';
            loadNextElement();
        }

        window.onload = () => {
            SCORM.init();
            initData();
            loadNextElement();
        };

        window.onbeforeunload = () => SCORM.terminate();
    </script>
</body>
</html>

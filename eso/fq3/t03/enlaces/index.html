<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego de Enlaces - 3º ESO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
        
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; }
        .element-card { transition: transform 0.3s ease, box-shadow 0.3s ease; position: relative; overflow: hidden; user-select: none; }
        .element-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.8); } 100% { opacity: 1; transform: scale(1); } }
        .animate-pop { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .selected-btn { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        .score-red { color: #dc2626; }
        .score-green { color: #16a34a; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4">

    <header class="w-full max-w-4xl flex justify-between items-center mb-8">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-gray-800"><i class="fa-solid fa-atom text-blue-600 mr-2"></i>Lab de Enlaces</h1>
            <p class="text-gray-500 text-sm">Objetivo: Llegar a nota 10 (Elementos de 3º ESO)</p>
        </div>
        <div class="bg-white px-4 py-2 rounded-xl shadow-sm border border-gray-200 flex items-center gap-3">
            <div class="text-center">
                <span class="block text-xs text-gray-400 uppercase font-bold">Nota</span>
                <span id="scoreDisplay" class="text-2xl font-bold score-red transition-colors duration-500">0.0</span>
            </div>
            <div class="h-8 w-px bg-gray-200"></div>
            <div class="text-center">
                <span class="block text-xs text-gray-400 uppercase font-bold">Rondas</span>
                <span id="cardsLeft" class="text-xl font-bold text-gray-400">0</span>
            </div>
        </div>
    </header>

    <main class="w-full max-w-2xl bg-white rounded-3xl shadow-xl overflow-hidden border border-gray-100 relative">
        
        <div id="gameOverLayer" class="absolute inset-0 z-10 bg-white/90 hidden flex-col items-center justify-center text-center p-8">
            <div class="text-6xl mb-4 text-yellow-500"><i class="fa-solid fa-trophy"></i></div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">¡Juego Terminado!</h2>
            <p class="text-xl text-gray-600 mb-6">Nota Final: <span id="finalScore" class="font-bold text-blue-600">10.0</span></p>
            <p class="text-sm text-gray-400 mb-4">(Nota guardada en Moodle)</p>
            <button onclick="location.reload()" class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold hover:bg-blue-700 transition transform hover:scale-105 shadow-lg">
                Jugar de nuevo
            </button>
        </div>

        <div class="bg-gradient-to-br from-slate-800 to-slate-900 p-8 flex justify-center items-center gap-4 md:gap-12 relative">
            <div class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none" 
                 style="background-image: radial-gradient(#ffffff 1px, transparent 1px); background-size: 20px 20px;"></div>

            <div id="card1" class="element-card animate-pop w-32 h-40 md:w-40 md:h-48 bg-gray-100 rounded-xl shadow-lg flex flex-col items-center justify-between p-3 border-b-4 border-blue-500 cursor-default">
                <div class="w-full flex justify-between text-xs font-bold text-gray-500">
                    <span class="text-xs">Z=<span id="z1"></span></span>
                    <span id="mass1" class="hidden"></span>
                </div>
                <div id="sym1" class="text-5xl md:text-6xl font-bold text-gray-800 my-auto"></div>
                <div id="name1" class="text-sm font-semibold text-gray-600 text-center"></div>
            </div>

            <div class="text-white text-2xl font-bold opacity-50">+</div>

            <div id="card2" class="element-card animate-pop w-32 h-40 md:w-40 md:h-48 bg-gray-100 rounded-xl shadow-lg flex flex-col items-center justify-between p-3 border-b-4 border-green-500 cursor-default">
                <div class="w-full flex justify-between text-xs font-bold text-gray-500">
                    <span class="text-xs">Z=<span id="z2"></span></span>
                    <span id="mass2" class="hidden"></span>
                </div>
                <div id="sym2" class="text-5xl md:text-6xl font-bold text-gray-800 my-auto"></div>
                <div id="name2" class="text-sm font-semibold text-gray-600 text-center"></div>
            </div>
        </div>

        <div class="p-6 md:p-8 space-y-8">
            
            <div class="space-y-3">
                <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                    <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">1</span>
                    Tendencia del <span id="qName1" class="text-blue-600 font-bold mx-1">...</span>:
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2" id="options1">
                    <button onclick="selectOption(1, 'lose')" class="opt-btn-1 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-blue-400 hover:bg-blue-50 transition text-gray-600" data-val="lose">Perder e⁻ (Metal)</button>
                    <button onclick="selectOption(1, 'gain')" class="opt-btn-1 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-blue-400 hover:bg-blue-50 transition text-gray-600" data-val="gain">Ganar/Compartir e⁻ (No Metal)</button>
                    <button onclick="selectOption(1, 'stable')" class="opt-btn-1 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-blue-400 hover:bg-blue-50 transition text-gray-600" data-val="stable">Estable (Gas Noble)</button>
                </div>
            </div>

            <div class="space-y-3">
                <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                    <span class="bg-green-100 text-green-600 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">2</span>
                    Tendencia del <span id="qName2" class="text-green-600 font-bold mx-1">...</span>:
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2" id="options2">
                    <button onclick="selectOption(2, 'lose')" class="opt-btn-2 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-blue-400 hover:bg-blue-50 transition text-gray-600" data-val="lose">Perder e⁻ (Metal)</button>
                    <button onclick="selectOption(2, 'gain')" class="opt-btn-2 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-blue-400 hover:bg-blue-50 transition text-gray-600" data-val="gain">Ganar/Compartir e⁻ (No Metal)</button>
                    <button onclick="selectOption(2, 'stable')" class="opt-btn-2 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-blue-400 hover:bg-blue-50 transition text-gray-600" data-val="stable">Estable (Gas Noble)</button>
                </div>
            </div>

            <div class="space-y-3 pt-4 border-t border-gray-100">
                <h3 class="text-lg font-semibold text-gray-700 flex items-center">
                    <span class="bg-purple-100 text-purple-600 w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">3</span>
                    ¿Qué tipo de enlace formarán?
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2" id="options3">
                    <button onclick="selectOption(3, 'ionic')" class="opt-btn-3 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-purple-400 hover:bg-purple-50 transition text-gray-600" data-val="ionic">Iónico</button>
                    <button onclick="selectOption(3, 'covalent')" class="opt-btn-3 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-purple-400 hover:bg-purple-50 transition text-gray-600" data-val="covalent">Covalente</button>
                    <button onclick="selectOption(3, 'metallic')" class="opt-btn-3 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-purple-400 hover:bg-purple-50 transition text-gray-600" data-val="metallic">Metálico</button>
                    <button onclick="selectOption(3, 'none')" class="opt-btn-3 border-2 border-gray-200 rounded-lg p-3 text-sm font-medium hover:border-purple-400 hover:bg-purple-50 transition text-gray-600" data-val="none">No reaccionan</button>
                </div>
            </div>

            <button onclick="checkAnswers()" class="w-full bg-slate-800 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-slate-700 transform active:scale-95 transition flex justify-center items-center gap-2">
                <i class="fa-solid fa-flask"></i> Verificar Resultados
            </button>
        </div>
    </main>

    <div id="feedbackModal" class="fixed inset-0 glass z-50 hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6 transform scale-95 transition-transform duration-300" id="modalContent">
            <div id="modalIcon" class="w-16 h-16 rounded-full mx-auto flex items-center justify-center text-3xl mb-4"></div>
            <h2 id="modalTitle" class="text-2xl font-bold text-center mb-2"></h2>
            <p id="modalMessage" class="text-gray-600 text-center mb-6"></p>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-6 text-sm text-left space-y-2 border border-gray-200">
                <p><span class="font-bold" id="resEl1Name"></span>: <span id="resEl1Type"></span></p>
                <p><span class="font-bold" id="resEl2Name"></span>: <span id="resEl2Type"></span></p>
                <p class="font-bold text-slate-800 pt-2 border-t border-gray-200 mt-2">Enlace: <span id="resBond" class="uppercase text-blue-600"></span></p>
                <p id="resExample" class="text-xs text-gray-500 italic mt-1"></p>
            </div>

            <button onclick="nextRound()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">
                Siguiente Pareja <i class="fa-solid fa-arrow-right ml-2"></i>
            </button>
        </div>
    </div>

    <script>
        /*******************************************************
         * BLOQUE SCORM 1.2 ROBUSTO (Moodle-Friendly)
         *******************************************************/
        var API = null;

        function findAPI(win) {
            var findAPITries = 0;
            while ((win.API == null) && (win.parent != null) && (win.parent != win)) {
                findAPITries++;
                if (findAPITries > 7) return null;
                win = win.parent;
            }
            return win.API;
        }

        function getAPI() {
            var theAPI = findAPI(window);
            if ((theAPI == null) && (window.opener != null) && (typeof(window.opener) != "undefined")) {
                theAPI = findAPI(window.opener);
            }
            if (theAPI == null) {
                console.warn("API SCORM no encontrada. Ejecutando en modo local.");
            }
            return theAPI;
        }

        function initSCORM() {
            API = getAPI();
            if (API) {
                API.LMSInitialize("");
                var status = API.LMSGetValue("cmi.core.lesson_status");
                if (status == "not attempted") {
                    API.LMSSetValue("cmi.core.lesson_status", "incomplete");
                }
                API.LMSSetValue("cmi.core.score.min", "0");
                API.LMSSetValue("cmi.core.score.max", "10");
                API.LMSSetValue("cmi.core.exit", "suspend");
                API.LMSCommit("");
            }
        }

        function sendScoreToMoodle(scoreVal, isFinal) {
            if (API) {
                var cleanScore = Math.max(0, Math.min(10, scoreVal));
                API.LMSSetValue("cmi.core.score.raw", cleanScore.toFixed(2));
                
                if (isFinal) {
                    if (cleanScore >= 5) {
                        API.LMSSetValue("cmi.core.lesson_status", "passed");
                    } else {
                        API.LMSSetValue("cmi.core.lesson_status", "failed");
                    }
                    API.LMSSetValue("cmi.core.exit", "");
                } else {
                    API.LMSSetValue("cmi.core.lesson_status", "incomplete");
                    API.LMSSetValue("cmi.core.exit", "suspend");
                }
                API.LMSCommit(""); 
            }
        }

        function finishSCORM() {
            if (API) {
                API.LMSCommit("");
                API.LMSFinish("");
            }
        }

        window.onunload = function() {
            finishSCORM();
        };
        
        /*******************************************************
         * DATOS DE ELEMENTOS (ADAPTADOS DEL JUEGO DE TABLA)
         *******************************************************/
        
        // Esta es EXACTAMENTE la lista del segundo código
        const RAW_ELEMENTS = [
          // Period 1
          {z:1,s:"H",n:"Hidrógeno",g:1,p:1}, {z:2,s:"He",n:"Helio",g:18,p:1},
          // Period 2
          {z:3,s:"Li",n:"Litio",g:1,p:2}, {z:4,s:"Be",n:"Berilio",g:2,p:2}, 
          {z:5,s:"B",n:"Boro",g:13,p:2}, {z:6,s:"C",n:"Carbono",g:14,p:2}, {z:7,s:"N",n:"Nitrógeno",g:15,p:2}, {z:8,s:"O",n:"Oxígeno",g:16,p:2}, {z:9,s:"F",n:"Flúor",g:17,p:2}, {z:10,s:"Ne",n:"Neón",g:18,p:2},
          // Period 3
          {z:11,s:"Na",n:"Sodio",g:1,p:3}, {z:12,s:"Mg",n:"Magnesio",g:2,p:3}, 
          {z:13,s:"Al",n:"Aluminio",g:13,p:3}, {z:14,s:"Si",n:"Silicio",g:14,p:3}, {z:15,s:"P",n:"Fósforo",g:15,p:3}, {z:16,s:"S",n:"Azufre",g:16,p:3}, {z:17,s:"Cl",n:"Cloro",g:17,p:3}, {z:18,s:"Ar",n:"Argón",g:18,p:3},
          // Period 4
          {z:19,s:"K",n:"Potasio",g:1,p:4}, {z:20,s:"Ca",n:"Calcio",g:2,p:4},
          {z:26,s:"Fe",n:"Hierro",g:8,p:4}, {z:27,s:"Co",n:"Cobalto",g:9,p:4}, {z:28,s:"Ni",n:"Níquel",g:10,p:4}, {z:29,s:"Cu",n:"Cobre",g:11,p:4}, {z:30,s:"Zn",n:"Zinc",g:12,p:4},
          {z:31,s:"Ga",n:"Galio",g:13,p:4}, {z:32,s:"Ge",n:"Germanio",g:14,p:4}, {z:33,s:"As",n:"Arsénico",g:15,p:4}, {z:34,s:"Se",n:"Selenio",g:16,p:4}, {z:35,s:"Br",n:"Bromo",g:17,p:4}, {z:36,s:"Kr",n:"Kriptón",g:18,p:4},
          // Period 5
          {z:37,s:"Rb",n:"Rubidio",g:1,p:5}, {z:38,s:"Sr",n:"Estroncio",g:2,p:5},
          {z:46,s:"Pd",n:"Paladio",g:10,p:5}, {z:47,s:"Ag",n:"Plata",g:11,p:5}, {z:48,s:"Cd",n:"Cadmio",g:12,p:5},
          {z:49,s:"In",n:"Indio",g:13,p:5}, {z:50,s:"Sn",n:"Estaño",g:14,p:5}, {z:51,s:"Sb",n:"Antimonio",g:15,p:5}, {z:52,s:"Te",n:"Telurio",g:16,p:5}, {z:53,s:"I",n:"Yodo",g:17,p:5}, {z:54,s:"Xe",n:"Xenón",g:18,p:5},
          // Period 6
          {z:55,s:"Cs",n:"Cesio",g:1,p:6}, {z:56,s:"Ba",n:"Bario",g:2,p:6},
          {z:78,s:"Pt",n:"Platino",g:10,p:6}, {z:79,s:"Au",n:"Oro",g:11,p:6}, {z:80,s:"Hg",n:"Mercurio",g:12,p:6},
          {z:81,s:"Tl",n:"Talio",g:13,p:6}, {z:82,s:"Pb",n:"Plomo",g:14,p:6}, {z:83,s:"Bi",n:"Bismuto",g:15,p:6}, {z:84,s:"Po",n:"Polonio",g:16,p:6}, {z:85,s:"At",n:"Astato",g:17,p:6}, {z:86,s:"Rn",n:"Radón",g:18,p:6},
          // Period 7
          {z:87,s:"Fr",n:"Francio",g:1,p:7}, {z:88,s:"Ra",n:"Radio",g:2,p:7}
        ];

        // Función para procesar la lista raw y añadirle la propiedad 'type' (metal, non-metal, noble)
        // para que funcione la lógica de enlaces
        function processElements(rawList) {
            const processed = {};
            
            rawList.forEach(el => {
                let type = 'metal'; // Por defecto
                
                // Lógica de clasificación simplificada para 3º ESO
                // Gas Noble: Grupo 18
                if (el.g === 18) {
                    type = 'noble';
                } 
                // No Metales y Metaloides (tratados como covalentes en este nivel):
                // Hidrógeno (G1), y el triángulo clásico de no metales
                else if (el.s === 'H' || [5,6,7,8,9,14,15,16,17,32,33,34,35,51,52,53,85].includes(el.z)) {
                    // Z numbers: B, C, N, O, F, Si, P, S, Cl, Ge, As, Se, Br, Sb, Te, I, At
                    type = 'non-metal';
                }
                
                processed[el.s] = {
                    z: el.z,
                    name: el.n,
                    sym: el.s,
                    type: type,
                    mass: '' // No usamos masa en el segundo código, la dejamos vacía
                };
            });
            return processed;
        }

        const elementsData = processElements(RAW_ELEMENTS);
        const keys = Object.keys(elementsData);

        // --- Game Logic Variables ---
        let questionDeck = [];
        let currentScenario = {};
        let score = 0.0;
        let roundsPlayed = 0;
        
        let userSelection = {
            el1: null,
            el2: null,
            bond: null
        };

        // DOM References
        const els = {
            card1: document.getElementById('card1'),
            card2: document.getElementById('card2'),
            z1: document.getElementById('z1'), z2: document.getElementById('z2'),
            sym1: document.getElementById('sym1'), sym2: document.getElementById('sym2'),
            name1: document.getElementById('name1'), name2: document.getElementById('name2'),
            qName1: document.getElementById('qName1'), qName2: document.getElementById('qName2'),
            score: document.getElementById('scoreDisplay'),
            cardsLeft: document.getElementById('cardsLeft'),
            modal: document.getElementById('feedbackModal'),
            modalContent: document.getElementById('modalContent'),
            gameOver: document.getElementById('gameOverLayer'),
            finalScore: document.getElementById('finalScore')
        };

        // --- SETUP DECK (GENERACIÓN DINÁMICA) ---
        // En lugar de usar listas fijas, generamos preguntas al vuelo usando SOLO los elementos disponibles
        function generateRandomQuestion() {
            const types = ['ionic', 'covalent', 'metallic', 'noble'];
            // Probabilidades: 35% Ionico, 35% Covalente, 15% Metalico, 15% Noble
            const rand = Math.random();
            let targetType = 'ionic';
            if (rand > 0.35) targetType = 'covalent';
            if (rand > 0.70) targetType = 'metallic';
            if (rand > 0.85) targetType = 'noble';

            // Filtrar listas
            const metals = keys.filter(k => elementsData[k].type === 'metal');
            const nonMetals = keys.filter(k => elementsData[k].type === 'non-metal');
            const nobles = keys.filter(k => elementsData[k].type === 'noble');

            let el1, el2, example;

            if (targetType === 'ionic') {
                if(metals.length === 0 || nonMetals.length === 0) return generateRandomQuestion(); // Safety
                el1 = metals[Math.floor(Math.random() * metals.length)];
                el2 = nonMetals[Math.floor(Math.random() * nonMetals.length)];
                example = `Compuesto Iónico (Metal + No Metal)`;
            } 
            else if (targetType === 'covalent') {
                if(nonMetals.length < 2) return generateRandomQuestion();
                el1 = nonMetals[Math.floor(Math.random() * nonMetals.length)];
                el2 = nonMetals[Math.floor(Math.random() * nonMetals.length)];
                example = `Compuesto Covalente (No Metal + No Metal)`;
            }
            else if (targetType === 'metallic') {
                if(metals.length === 0) return generateRandomQuestion();
                el1 = metals[Math.floor(Math.random() * metals.length)];
                // A veces aleación, a veces puro
                el2 = (Math.random() > 0.5) ? el1 : metals[Math.floor(Math.random() * metals.length)];
                example = (el1 === el2) ? "Enlace Metálico (Elemento puro)" : "Aleación (Mezcla de metales)";
            }
            else { // Noble
                 if(nobles.length === 0) return generateRandomQuestion();
                 el1 = nobles[Math.floor(Math.random() * nobles.length)];
                 el2 = keys[Math.floor(Math.random() * keys.length)];
                 example = (el1 === el2) ? "Átomo libre (Gas Noble)" : "Sin reacción (Gas Inerte)";
                 targetType = 'none'; // Para la lógica de respuesta
            }

            // Mezclar orden visual
            let sym1 = el1, sym2 = el2;
            if (Math.random() > 0.5) { [sym1, sym2] = [sym2, sym1]; }

            return { sym1, sym2, example, type: targetType };
        }

        // --- HELPERS ---
        function getTypeAnswer(type) {
            if (type === 'metal') return 'lose';
            if (type === 'non-metal') return 'gain';
            if (type === 'noble') return 'stable';
            return '';
        }

        function getReadableType(type) {
            if (type === 'metal') return 'Metal (Pierde e⁻)';
            if (type === 'non-metal') return 'No Metal (Gana/Comparte e⁻)';
            if (type === 'noble') return 'Gas Noble (Estable)';
        }

        function getReadableBond(bond) {
            if (bond === 'ionic') return 'Iónico (Transferencia)';
            if (bond === 'covalent') return 'Covalente (Compartición)';
            if (bond === 'metallic') return 'Metálico (Mar de electrones)';
            if (bond === 'none') return 'No forman enlace';
        }

        // --- GAME FLOW ---
        function initGame() {
            initSCORM();
            score = 0;
            roundsPlayed = 0;
            updateScoreUI();
            nextQuestion();
        }

        function nextQuestion() {
            // Check win condition (20 rondas para aprobar/terminar o llegar al 10)
            if (score >= 10.0) {
                endGame(true);
                return;
            }

            roundsPlayed++;
            els.cardsLeft.textContent = roundsPlayed;

            // Generate fresh question from the dynamic pool
            const q = generateRandomQuestion();

            const el1Data = elementsData[q.sym1];
            const el2Data = elementsData[q.sym2];

            currentScenario = {
                el1: { ...el1Data, sym: q.sym1 },
                el2: { ...el2Data, sym: q.sym2 },
                bond: q.type,
                example: q.example
            };

            // Update UI
            updateCard(els.card1, currentScenario.el1, 1);
            updateCard(els.card2, currentScenario.el2, 2);

            els.qName1.textContent = currentScenario.el1.name;
            els.qName2.textContent = currentScenario.el2.name;

            // Reset Selections
            userSelection = { el1: null, el2: null, bond: null };
            document.querySelectorAll('.selected-btn').forEach(btn => btn.classList.remove('selected-btn'));
        }

        function updateCard(cardEl, data, num) {
            document.getElementById(`z${num}`).textContent = data.z;
            // Ocultamos la masa porque no está en la base de datos nueva, solo Z
            // document.getElementById(`mass${num}`).textContent = data.mass; 
            document.getElementById(`sym${num}`).textContent = data.sym;
            document.getElementById(`name${num}`).textContent = data.name;
            
            // Pop animation
            cardEl.classList.remove('animate-pop');
            void cardEl.offsetWidth;
            cardEl.classList.add('animate-pop');
        }

        function selectOption(group, value) {
            document.querySelectorAll(`.opt-btn-${group}`).forEach(btn => btn.classList.remove('selected-btn'));
            const clickedBtn = document.querySelector(`.opt-btn-${group}[data-val="${value}"]`);
            if(clickedBtn) clickedBtn.classList.add('selected-btn');

            if (group === 1) userSelection.el1 = value;
            if (group === 2) userSelection.el2 = value;
            if (group === 3) userSelection.bond = value;
        }

        function checkAnswers() {
            if (!userSelection.el1 || !userSelection.el2 || !userSelection.bond) {
                showModal('Incompleto', 'Por favor, selecciona una opción en cada una de las 3 preguntas.', 'warning');
                return;
            }

            const correctType1 = getTypeAnswer(currentScenario.el1.type);
            const correctType2 = getTypeAnswer(currentScenario.el2.type);
            const correctBond = currentScenario.bond;

            const isCorrect1 = userSelection.el1 === correctType1;
            const isCorrect2 = userSelection.el2 === correctType2;
            const isCorrectBond = userSelection.bond === correctBond;

            const allCorrect = isCorrect1 && isCorrect2 && isCorrectBond;

            if (allCorrect) {
                score += 0.5; // +0.5 por acierto
                showModal('¡Correcto!', `Has acertado.<br><b>${currentScenario.example}</b>`, 'success');
            } else {
                score = Math.max(0, score - 0.25); 
                
                let msg = 'Revisa tus respuestas:<br>';
                if (!isCorrect1) msg += `- ${currentScenario.el1.name}: ${getReadableType(currentScenario.el1.type)}.<br>`;
                if (!isCorrect2) msg += `- ${currentScenario.el2.name}: ${getReadableType(currentScenario.el2.type)}.<br>`;
                if (!isCorrectBond) msg += `- Tipo de enlace real: <b>${getReadableBond(correctBond)}</b>.`;
                
                showModal('Error', msg, 'error');
            }

            updateScoreUI();
            sendScoreToMoodle(score, false); 
        }

        function updateScoreUI() {
            els.score.textContent = score.toFixed(1); 
            if (score >= 5.0) {
                els.score.classList.remove('score-red');
                els.score.classList.add('score-green');
            } else {
                els.score.classList.add('score-red');
                els.score.classList.remove('score-green');
            }
        }

        function showModal(title, message, type) {
            const modal = els.modal;
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMsg = document.getElementById('modalMessage');

            modalTitle.textContent = title;
            modalMsg.innerHTML = message;

            if (type === 'success') {
                modalIcon.className = 'w-16 h-16 rounded-full mx-auto flex items-center justify-center text-3xl mb-4 bg-green-100 text-green-600';
                modalIcon.innerHTML = '<i class="fa-solid fa-check"></i>';
                document.getElementById('resExample').textContent = ""; 
            } else if (type === 'error') {
                modalIcon.className = 'w-16 h-16 rounded-full mx-auto flex items-center justify-center text-3xl mb-4 bg-red-100 text-red-600';
                modalIcon.innerHTML = '<i class="fa-solid fa-xmark"></i>';
                document.getElementById('resExample').textContent = "";
            } else {
                modalIcon.className = 'w-16 h-16 rounded-full mx-auto flex items-center justify-center text-3xl mb-4 bg-yellow-100 text-yellow-600';
                modalIcon.innerHTML = '<i class="fa-solid fa-exclamation"></i>';
                document.getElementById('resExample').textContent = "";
            }

            document.getElementById('resEl1Name').textContent = currentScenario.el1.name;
            document.getElementById('resEl1Type').textContent = getReadableType(currentScenario.el1.type);
            document.getElementById('resEl2Name').textContent = currentScenario.el2.name;
            document.getElementById('resEl2Type').textContent = getReadableType(currentScenario.el2.type);
            document.getElementById('resBond').textContent = getReadableBond(currentScenario.bond);

            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                modal.classList.remove('opacity-0');
                els.modalContent.classList.remove('scale-95');
                els.modalContent.classList.add('scale-100');
            });
        }

        function nextRound() {
            const modal = els.modal;
            modal.classList.add('opacity-0');
            els.modalContent.classList.remove('scale-100');
            els.modalContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                nextQuestion();
            }, 300);
        }

        function endGame() {
            els.finalScore.textContent = score.toFixed(1);
            els.gameOver.classList.remove('hidden');
            els.gameOver.classList.add('flex');
            sendScoreToMoodle(score, true); 
        }

        // Start
        initGame();

    </script>
</body>
</html>
